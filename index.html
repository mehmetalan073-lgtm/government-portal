<!DOCTYPE html>
<html lang="de">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèõÔ∏è</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regierungspanel- SQL-Datenbank</title>
    <style>
        body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#6a4c93 0%,#8b3b97 50%,#9c4dc4 100%);margin:0;padding:0;min-height:100vh;transition:all 0.3s ease;overflow:hidden}
        
        /* Dark Mode */
        body.dark{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%)}
        body.dark .container{background:#2d2d2d;color:#e0e0e0}
        body.dark .header{border-bottom:2px solid #4a4a4a}
        body.dark h1{color:#e0e0e0}
        body.dark .subtitle{color:#b0b0b0}
        body.dark .system-info{background:linear-gradient(135deg,#3a3a5c 0%,#2d2d4f 100%);border:1px solid #4a4a6a;color:#c0c0ff}
        body.dark label{color:#e0e0e0}
        body.dark input,body.dark textarea{background:#3a3a3a;border:2px solid #4a4a4a;color:#e0e0e0}
        body.dark input:focus,body.dark textarea:focus{border-color:#6a4c93;box-shadow:0 0 0 3px rgba(106,76,147,0.3)}
        body.dark .user-info{background:linear-gradient(135deg,#3a3a3a 0%,#2d2d2d 100%);border:1px solid #4a4a4a;color:#e0e0e0}
        body.dark .content-area{background:linear-gradient(135deg,#2d2d2d 0%,#3a3a3a 100%);color:#e0e0e0}
        body.dark .stat-card{background:#3a3a3a;border-left:4px solid #6a4c93;color:#e0e0e0}
        body.dark .user-card{background:#3a3a3a;border:1px solid #4a4a4a;color:#e0e0e0}
        body.dark .pending-users{background:linear-gradient(135deg,#4a4a2e 0%,#3a3a28 100%);border:1px solid #6a6a4a}
        body.dark .db-info{background:linear-gradient(135deg,#2e4a2e 0%,#284a28 100%);border:1px solid #4a6a4a;color:#c0ffc0}
        body.dark .dropdown-menu{background:#2d2d2d;border:1px solid #4a4a4a;color:#e0e0e0}
        body.dark .dropdown-header{background:linear-gradient(135deg,#3a3a5c 0%,#2d2d4f 100%)}
        body.dark .dropdown-user-name{color:#c0c0ff}
        body.dark .dropdown-user-role{color:#b0b0b0}
        body.dark .dropdown-user-time{color:#999}
        body.dark .dropdown-item{color:#e0e0e0}
        body.dark .dropdown-item:hover{background:linear-gradient(135deg,#3a3a5c 0%,#2d2d4f 100%);color:#c0c0ff}
        body.dark .dropdown-item.danger{color:#ff6b6b}
        body.dark .dropdown-item.danger:hover{background:linear-gradient(135deg,#4a2d2d 0%,#3a2828 100%);color:#ff8a8a}
        body.dark .top-nav{background:rgba(45,45,45,0.95);border-bottom:2px solid #4a4a4a}
        body.dark .nav-user{color:#e0e0e0}
        body.dark .nav-user .user-name{color:#c0c0ff}
        body.dark .nav-logo{color:#c0c0ff}
        body.dark .admin-badge-nav{background:#dc3545;color:white}
        body.dark .admin-badge-nav.rank-nc-team{background:#ff6b35}
        body.dark .admin-badge-nav.rank-president{background:linear-gradient(135deg,#ffd700 0%,#ffb700 100%);color:#333}
        body.dark .admin-badge-nav.rank-vice-president{background:linear-gradient(135deg,#c0c0c0 0%,#a0a0a0 100%);color:#333}
        body.dark .admin-badge-nav.rank-admin{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%)}
        body.dark .admin-badge-nav.rank-kabinettsmitglied{background:linear-gradient(135deg,#17a2b8 0%,#138496 100%)}
        body.dark .admin-badge-nav.rank-socom-operator{background:linear-gradient(135deg,#28a745 0%,#20a038 100%)}
        body.dark .admin-badge-nav.rank-user{background:linear-gradient(135deg,#6c757d 0%,#5a6268 100%)}
        body.dark .admin-badge-nav.rank-besucher{background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);color:#333}

     
     /* Top Navigation */
     .top-nav{position:fixed;top:0;left:0;right:0;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-bottom:2px solid #6a4c93;padding:15px 30px;display:none;align-items:center;justify-content:space-between;z-index:1000;box-shadow:0 2px 20px rgba(106,76,147,0.2)}
        .top-nav.active{display:flex}
        .nav-left{display:flex;align-items:center;gap:20px}
        .nav-logo{font-size:20px;color:#6a4c93;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:8px}
        .nav-logo:hover{transform:translateY(-1px);color:#5a3c83}
        .nav-user{display:flex;align-items:center;gap:15px;color:#2c2c2c;font-size:14px}
        .nav-user .user-name{font-weight:600;color:#6a4c93}
        .nav-buttons{display:flex;gap:10px;align-items:center}
        .nav-btn{padding:8px 16px;border:none;border-radius:6px;font-size:13px;cursor:pointer;font-weight:500;transition:all 0.3s ease}
        .nav-btn.admin{background:#ffc107;color:#212529}
        .nav-btn.admin:hover{background:#e0a800}
        .nav-btn.users{background:#6c757d;color:white}
        .nav-btn.users:hover{background:#5a6268}
        .admin-badge-nav{background:#dc3545;color:white;padding:2px 6px;border-radius:3px;font-size:10px;margin-left:5px;font-weight:600}
        .admin-badge-nav.rank-nc-team{background:linear-gradient(135deg,#ff6b35 0%,#f7931e 100%);color:white}
        .admin-badge-nav.rank-president{background:linear-gradient(135deg,#ffd700 0%,#ffb700 100%);color:#333}
        .admin-badge-nav.rank-vice-president{background:linear-gradient(135deg,#c0c0c0 0%,#a0a0a0 100%);color:#333}
        .admin-badge-nav.rank-admin{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);color:white}
        .admin-badge-nav.rank-kabinettsmitglied{background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);color:white}
        .admin-badge-nav.rank-socom-operator{background:linear-gradient(135deg,#28a745 0%,#20a038 100%);color:white}
        .admin-badge-nav.rank-user{background:linear-gradient(135deg,#6c757d 0%,#5a6268 100%);color:white}
        .admin-badge-nav.rank-besucher{background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);color:#333;border:1px solid #dee2e6}
        
        /* User Dropdown */
        .user-dropdown{position:relative}
        .dropdown-toggle{display:flex;align-items:center;gap:8px;padding:10px 15px;background:linear-gradient(135deg,#6a4c93 0%,#8b3b97 100%);color:white;border:none;border-radius:8px;font-size:14px;cursor:pointer;font-weight:500;transition:all 0.3s ease;box-shadow:0 2px 10px rgba(106,76,147,0.3)}
        .dropdown-toggle:hover{background:linear-gradient(135deg,#5a3c83 0%,#7b2b87 100%);transform:translateY(-1px);box-shadow:0 4px 15px rgba(106,76,147,0.4)}
        .dropdown-arrow{transition:transform 0.3s ease;font-size:12px}
        .dropdown-toggle.active .dropdown-arrow{transform:rotate(180deg)}
        .dropdown-menu{position:absolute;top:calc(100% + 10px);right:0;background:white;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.15);border:1px solid #e0e0e0;min-width:200px;opacity:0;visibility:hidden;transform:translateY(-10px);transition:all 0.3s ease;z-index:1001}
        .dropdown-menu.active{opacity:1;visibility:visible;transform:translateY(0)}
        .dropdown-header{padding:15px;border-bottom:1px solid #f0f0f0;background:linear-gradient(135deg,#f8f6ff 0%,#ede8ff 100%)}
        .dropdown-user-name{font-weight:600;color:#6a4c93;font-size:16px}
        .dropdown-user-role{font-size:12px;color:#666;margin-top:2px}
        .dropdown-user-time{font-size:11px;color:#999;margin-top:4px}
        .dropdown-item{display:flex;align-items:center;gap:10px;padding:12px 15px;color:#333;text-decoration:none;border:none;background:none;width:100%;text-align:left;font-size:14px;cursor:pointer;transition:all 0.3s ease}
        .dropdown-item:hover{background:linear-gradient(135deg,#f8f6ff 0%,#ede8ff 100%);color:#6a4c93}
        .dropdown-item.danger{color:#dc3545}
        .dropdown-item.danger:hover{background:linear-gradient(135deg,#fdf2f2 0%,#fce8e8 100%);color:#c82333}
        .dropdown-item-icon{font-size:16px;width:20px;text-align:center}
        .dropdown-divider{height:1px;background:#f0f0f0;margin:5px 0}
        
        /* Container */
        .page-wrapper{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;overflow:hidden}
        .page-wrapper.with-nav{padding-top:100px;align-items:flex-start;overflow:hidden}
        .container{background:white;padding:40px;border-radius:8px;box-shadow:0 20px 60px rgba(106,76,147,0.3);width:100%;max-width:600px;max-height:calc(85vh - 80px);overflow-y:auto}
        
        .header{text-align:center;margin-bottom:30px;border-bottom:2px solid #6a4c93;padding-bottom:20px}
        .logo{font-size:24px;color:#6a4c93;margin-bottom:10px}
        h1{color:#2c2c2c;margin:0;font-size:24px;font-weight:600}
        .subtitle{color:#666;font-size:14px;margin-top:5px}
        .system-info{background:linear-gradient(135deg,#f8f6ff 0%,#ede8ff 100%);border:1px solid #d1c4e9;padding:15px;border-radius:6px;margin-bottom:25px;font-size:13px;color:#4a148c}
        .form-group{margin-bottom:18px}
        label{display:block;margin-bottom:6px;color:#2c2c2c;font-weight:500;font-size:14px}
        input,textarea{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:4px;font-size:14px;box-sizing:border-box;font-family:inherit}
        input:focus,textarea:focus{border-color:#6a4c93;outline:none;box-shadow:0 0 0 3px rgba(106,76,147,0.1)}
        textarea{resize:vertical;min-height:80px}
        button{width:100%;padding:14px;background:linear-gradient(135deg,#6a4c93 0%,#8b3b97 100%);color:white;border:none;border-radius:4px;font-size:15px;cursor:pointer;font-weight:500;margin-bottom:12px;transition:all 0.3s ease}
        button:hover:not(:disabled){background:linear-gradient(135deg,#5a3c83 0%,#7b2b87 100%);transform:translateY(-1px)}
        button:disabled{background:#bbb;cursor:not-allowed;transform:none}
        .btn-secondary{background:linear-gradient(135deg,#6c757d 0%,#5a6268 100%)}
        .btn-success{background:linear-gradient(135deg,#28a745 0%,#20a038 100%)}
        .btn-danger{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%)}
        .btn-warning{background:linear-gradient(135deg,#ffc107 0%,#e0a800 100%);color:#212529}
        .error{color:#dc3545;text-align:center;margin:12px 0;font-size:14px;font-weight:500}
        .success{color:#28a745;text-align:center;margin:12px 0;font-size:14px;font-weight:500}
        .screen{display:none}.screen.active{display:block}
        
        /* Content */
        .content-area{background:linear-gradient(135deg,#f8f9fa 0%,#ffffff 100%);border-radius:10px;padding:30px;margin:20px 0;min-height:400px}
        .welcome-message{text-align:center;color:#6a4c93;font-size:18px;margin-bottom:30px}
        .quick-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:30px}
        .stat-card{background:white;padding:20px;border-radius:8px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.1);border-left:4px solid #6a4c93}
        .stat-number{font-size:24px;font-weight:600;color:#6a4c93;display:block}
        .stat-label{font-size:12px;color:#666;text-transform:uppercase;margin-top:5px}
        .user-info{background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);border:1px solid #dee2e6;padding:20px;border-radius:6px;margin:20px 0}
        .pending-users{background:linear-gradient(135deg,#fff8e1 0%,#ffecb3 100%);border:1px solid #ffb74d;border-radius:6px;padding:20px;margin:20px 0}
        .user-card{background:white;border:1px solid #ddd;border-radius:6px;padding:20px;margin:15px 0;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
        .user-actions{display:flex;gap:12px;margin-top:15px;flex-wrap:wrap}
        .user-actions button{width:auto;padding:8px 16px;margin:0;font-size:13px}
        .status{padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;text-transform:uppercase}
        .status.pending{background:#fff3cd;color:#856404;border:1px solid #ffeaa7}
        .status.approved{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
        .admin-badge{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);color:white;padding:4px 8px;border-radius:3px;font-size:10px;margin-left:8px;font-weight:600}
        .db-info{background:linear-gradient(135deg,#e8f5e8 0%,#d4edda 100%);border:1px solid #28a745;padding:15px;border-radius:6px;margin:20px 0;font-size:13px;color:#155724}
        .loading{text-align:center;color:#6a4c93;padding:20px}
        
        /* Documents Modal - FIXED SCROLLING */
        .documents-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(5px)}
        .documents-modal.active{display:flex}
        .documents-modal-content{background:white;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.3);width:90%;max-width:900px;height:85vh;max-height:85vh;overflow:hidden;position:relative;animation:modalSlideIn 0.3s ease;z-index:10000;display:flex;flex-direction:column}
        .documents-modal-header{background:linear-gradient(135deg,#6a4c93 0%,#8b3b97 100%);color:white;padding:20px 30px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
        .documents-modal-title{font-size:20px;font-weight:600;margin:0}
        .documents-modal-close{background:none;border:none;color:white;font-size:24px;cursor:pointer;padding:8px;border-radius:50%;transition:all 0.3s ease;width:40px;height:40px;display:flex;align-items:center;justify-content:center}
        .documents-modal-close:hover{background:rgba(255,255,255,0.2);transform:rotate(90deg)}
        .documents-modal-body{padding:20px 30px 40px 30px;overflow-y:auto;flex:1;min-height:0}
        .documents-tabs{display:flex;gap:10px;margin-bottom:25px;border-bottom:2px solid #f0f0f0}
        .documents-tab{padding:12px 20px;background:none;border:none;cursor:pointer;font-size:14px;font-weight:500;color:#666;border-bottom:3px solid transparent;transition:all 0.3s ease}
        .documents-tab.active{color:#6a4c93;border-bottom-color:#6a4c93}
        .documents-tab:hover{color:#6a4c93}
        .documents-content{min-height:auto;padding-bottom:20px}
        .document-form{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px}
        .document-form .form-group{margin-bottom:15px}
        .document-form .form-group.full-width{grid-column:1 / -1}
        .document-item{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:20px;margin-bottom:15px;transition:all 0.3s ease}
        .document-item:hover{box-shadow:0 4px 15px rgba(106,76,147,0.1);transform:translateY(-2px)}
        .document-date{font-size:12px;color:#666;margin-bottom:8px}
        .document-title{font-size:16px;font-weight:600;color:#2c2c2c;margin-bottom:10px}
        .document-details{font-size:14px;color:#555}
        .document-actions{margin-top:15px;display:flex;gap:10px}
        .document-actions button{width:auto;margin:0;padding:8px 16px;font-size:13px}
        
        /* G-Docs specific styles */
        .gdocs-rank-selector{display:flex;gap:15px;flex-wrap:wrap;margin:10px 0}
        .gdocs-rank-selector label{display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer}
        .gdocs-rank-selector input[type="checkbox"]{margin:0;width:auto;height:auto}
        
        /* Questions Container */
        .questions-container{border:1px solid #e0e0e0;border-radius:6px;padding:15px;margin:10px 0;background:#f8f9fa}
        .question-item{background:white;border:1px solid #dee2e6;border-radius:6px;padding:15px;margin:10px 0;position:relative}
        .question-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .question-number{font-weight:600;color:#6a4c93;font-size:14px}
        .question-remove{background:#dc3545;color:white;border:none;border-radius:4px;padding:4px 8px;font-size:12px;cursor:pointer}
        .question-remove:hover{background:#c82333}
        .question-fields{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
        .question-fields .form-group{margin:0}
        .question-fields .form-group.full{grid-column:1 / -1}
        
        /* Dark Mode f√ºr Questions */
body.dark .questions-container{background:#3a3a3a;border-color:#4a4a4a}
body.dark .question-item{background:#2d2d2d;border-color:#4a4a4a;color:#e0e0e0}
body.dark .question-number{color:#c0c0ff}

/* Dark Mode f√ºr Edit Questions Modal */
body.dark #editQuestionsModal .documents-modal-content{background:#2d2d2d;color:#e0e0e0}
body.dark #editQuestionsModal .question-item{background:#2d2d2d;border-color:#4a4a4a;color:#e0e0e0}
body.dark #editQuestionsModal .question-number{color:#c0c0ff}
body.dark #editQuestionsModal input,body.dark #editQuestionsModal textarea,body.dark #editQuestionsModal select{background:#3a3a3a;border-color:#4a4a4a;color:#e0e0e0}
body.dark #editQuestionsModal label{color:#e0e0e0}
        
        /* Dark Mode f√ºr Modal */
        body.dark .documents-modal-content{background:#2d2d2d;color:#e0e0e0}
        body.dark .documents-modal-body{color:#e0e0e0}
        body.dark .documents-tab{color:#b0b0b0}
        body.dark .documents-tab.active{color:#c0c0ff}
        body.dark .documents-tabs{border-bottom-color:#4a4a4a}
        body.dark .document-item{background:#3a3a3a;border-color:#4a4a4a;color:#e0e0e0}
        body.dark .document-title{color:#e0e0e0}
        body.dark .document-details{color:#c0c0c0}
        body.dark .document-date{color:#888}
        
        @keyframes modalSlideIn{from{opacity:0;transform:scale(0.9) translateY(-20px)}to{opacity:1;transform:scale(1) translateY(0)}}
        @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
        
        /* Responsive f√ºr Modal */
        @media (max-width: 768px){
            .documents-modal-content{width:95%;margin:20px}
            .documents-modal-header{padding:15px 20px}
            .documents-modal-body{padding:20px}
            .document-form{grid-template-columns:1fr;gap:15px}
        }
        
        /* Toggle Switch for Dark Mode - Fixed */
        .toggle-switch{position:relative;display:inline-block;width:60px;height:28px}
        .toggle-switch input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:0.3s;border-radius:28px}
        .toggle-slider:before{position:absolute;content:"";height:20px;width:20px;left:4px;bottom:4px;background-color:white;transition:0.3s;border-radius:50%}
        input:checked + .toggle-slider{background:linear-gradient(135deg,#6a4c93 0%,#8b3b97 100%)}
        input:checked + .toggle-slider:before{transform:translateX(22px)}
        body.dark .toggle-slider{background-color:#555}
        body.dark input:checked + .toggle-slider{background:linear-gradient(135deg,#6a4c93 0%,#8b3b97 100%)}
        
        /* Rank Management Styles */
        .rank-badge{padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;margin-left:8px}
        .rank-nc-team{background:linear-gradient(135deg,#ff6b35 0%,#f7931e 100%);color:white}
        .rank-president{background:linear-gradient(135deg,#ffd700 0%,#ffb700 100%);color:#333}
        .rank-vice-president{background:linear-gradient(135deg,#c0c0c0 0%,#a0a0a0 100%);color:#333}
        .rank-admin{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);color:white}
        .rank-kabinettsmitglied{background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);color:white}
        .rank-socom-operator{background:linear-gradient(135deg,#28a745 0%,#20a038 100%);color:white}
        .rank-user{background:linear-gradient(135deg,#6c757d 0%,#5a6268 100%);color:white}
        .rank-besucher{background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);color:#333;border:1px solid #dee2e6}
        
        .rank-selector{margin:10px 0}
        .rank-selector select{padding:8px 12px;border:2px solid #e0e0e0;border-radius:4px;font-size:13px;background:white}
        body.dark .rank-selector select{background:#3a3a3a;border-color:#4a4a4a;color:#e0e0e0}
    </style>
    <style>
/* Dark Mode f√ºr Dropdown */
body.dark #documentsViewDropdown {
    background: #3a3a3a;
    border-color: #4a4a4a;
    color: #e0e0e0;
}

body.dark #documentsViewInfo {
    background: #3a3a3a;
    color: #c0c0c0;
    border: 1px solid #4a4a4a;
}
        /* Template-Filter Dark Mode */
body.dark #templateFilterContainer select {
    background: #3a3a3a;
    border-color: #4a4a4a;
    color: #e0e0e0;
}

body.dark #templateFilterContainer label {
    color: #e0e0e0;
}

/* Responsive Design f√ºr Filter */
@media (max-width: 768px) {
    #viewDocumentsTab > div:first-child > div:last-child {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
    }
    
    #documentsViewDropdown,
    #templateFilterDropdown {
        min-width: 140px;
    }
}

/* Dokument-Item Styles f√ºr unterschiedliche Ersteller /
.document-item[style*="border-left: 4px solid #17a2b8"] {
    background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
}

body.dark .document-item[style*="border-left: 4px solid #17a2b8"] {
    background: linear-gradient(135deg, #1a2332 0%, #0f1928 100%);
}

/* Ersteller-Badge Styling */
.creator-badge {
    display: inline-block;
    background: #17a2b8;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 8px;
}

/* Responsive Dropdown */
@media (max-width: 768px) {
    #viewDocumentsTab > div:first-child {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    #viewDocumentsTab > div:first-child > div {
        width: 100%;
        justify-content: flex-end;
    }
    
    #documentsViewDropdown {
        min-width: 200px;
    }
}
</style>
</head>
<body>
    <!-- Top Navigation -->
    <div id="topNav" class="top-nav">
        <div class="nav-left">
            <div class="nav-logo" onclick="goToHomePage()">
                <span>üèõÔ∏è</span>
                <span>Regierungspanel</span>
            </div>
            <div class="nav-user">
                <span>Angemeldet als:</span>
                <span class="user-name" id="navUserName">Admin</span>
                <span id="navUserRole" class="admin-badge-nav">ADMIN</span>
            </div>
        </div>
        <div class="nav-buttons">
            <button class="nav-btn admin" id="navPendingBtn" onclick="loadPendingUsers()" style="display:none">üìã Offene Antr√§ge</button>
            <button class="nav-btn users" id="navUsersBtn" onclick="loadAllUsers()" style="display:none">üë• Benutzer</button>
            <button class="nav-btn admin" id="navLogBtn" onclick="loadSystemLog()" style="display:none">üìú System-Log</button>
            <button class="nav-btn users" id="navDocumentsBtn" onclick="openDocumentsModal()" style="display:block">üìÑ Dokumente</button>
            
            <div class="user-dropdown">
                <button class="dropdown-toggle" onclick="toggleUserDropdown()">
                    <span>üë§</span>
                    <span id="dropdownUserName">Admin</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </button>
                
                <div class="dropdown-menu" id="userDropdownMenu">
                    <div class="dropdown-header">
                        <div class="dropdown-user-name" id="dropdownUserFullName">Administrator</div>
                        <div class="dropdown-user-role" id="dropdownUserRoleText">Administrator</div>
                        <div class="dropdown-user-time" id="dropdownLoginTime">Angemeldet: --:--</div>
                    </div>
                    
                    <button class="dropdown-item" onclick="showProfile()">
                        <span class="dropdown-item-icon">üë§</span>
                        Profil anzeigen
                    </button>
                    
                    <button class="dropdown-item" onclick="showSettings()">
                        <span class="dropdown-item-icon">‚öôÔ∏è</span>
                        Einstellungen
                    </button>
                    
                    <div class="dropdown-divider"></div>
                    
                    <button class="dropdown-item danger" onclick="logout()">
                        <span class="dropdown-item-icon">üö™</span>
                        Abmelden
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="page-wrapper" id="pageWrapper">
        <div class="container" id="mainContainer">
            <!-- Login Screen -->
            <div id="loginScreen" class="screen active">
                <div class="header">
                    <div class="logo">üèõÔ∏è</div>
                    <h1>Regierungspanel</h1>
                    <div class="subtitle">Zugriff nur f√ºr Mitarbeiter der Regierung</div>
                </div>
                <div class="form-group"><label>Benutzername:</label><input type="text" id="username" placeholder="Amtlicher Benutzername"></div>
                <div class="form-group"><label>Passwort:</label><input type="password" id="password" placeholder="Sicherheitskennwort"></div>
                <button onclick="attemptLogin()">Anmelden</button>
                <button class="btn-secondary" onclick="showRegister()">Zugangsantrag stellen</button>
                <div id="loginError" class="error"></div>
                <div class="db-info">üìä <strong>SQLite Datenbank aktiv:</strong> government_portal.db<br>Alle Daten werden permanent gespeichert</div>
            </div>

            <!-- Register Screen -->
            <div id="registerScreen" class="screen">
                <div class="header">
                    <div class="logo">üìã</div>
                    <h1>Zugangsantrag</h1>
                    <div class="subtitle">Antrag auf Systemzugang</div>
                </div>
                <div class="system-info"><strong>Wichtiger Hinweis:</strong><br>Ihr Antrag wird in der SQL-Datenbank gespeichert und von einem Administrator gepr√ºft.</div>
                <div class="form-group"><label>Gew√ºnschter Benutzername:</label><input type="text" id="newUsername" placeholder="Eindeutige Benutzerkennung" maxlength="20"></div>
                <div class="form-group"><label>Vollst√§ndiger Name:</label><input type="text" id="fullName" placeholder="Vor- und Nachname" maxlength="50"></div>
                <div class="form-group"><label>Sicherheitskennwort:</label><input type="password" id="newPassword" placeholder="Mindestens 6 Zeichen" maxlength="50"></div>
                <div class="form-group"><label>Kennwort best√§tigen:</label><input type="password" id="confirmPassword" placeholder="Kennwort wiederholen" maxlength="50"></div>
                <div class="form-group"><label>Dienstliche Begr√ºndung:</label><textarea id="reason" placeholder="Begr√ºndung f√ºr den Systemzugang" maxlength="300"></textarea></div>
                <button onclick="submitRegistration()">Antrag einreichen</button>
                <button class="btn-secondary" onclick="showLogin()">Zur√ºck zur Anmeldung</button>
                <div id="registerError" class="error"></div>
                <div id="registerSuccess" class="success"></div>
            </div>

            <!-- User Dashboard -->
            <div id="userDashboard" class="screen">
                <div class="header">
                    <div class="logo">üë§</div>
                    <h1>Benutzer-Terminal</h1>
                    <div class="subtitle">Authentifiziert √ºber SQL-Datenbank</div>
                </div>
                
                <div class="content-area">
                    <div class="welcome-message">‚úÖ Willkommen im sicheren Beh√∂rdensystem!</div>
                    
                    <div class="quick-stats">
                        <div class="stat-card">
                            <span class="stat-number">üîê</span>
                            <div class="stat-label">Sicher authentifiziert</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">üìä</span>
                            <div class="stat-label">SQL-Datenbank</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">‚úÖ</span>
                            <div class="stat-label">System aktiv</div>
                        </div>
                    </div>
                    
                    <div class="user-info">
                        <h3>Ihre Benutzerinformationen</h3>
                        <p><strong>Name:</strong> <span id="currentUser">Laden...</span></p>
                        <p><strong>Berechtigung:</strong> <span id="userRole">Laden...</span></p>
                        <p><strong>Anmeldezeit:</strong> <span id="loginTime">Laden...</span></p>
                        <p><strong>Datenstatus:</strong> Permanent in SQL-Datenbank gespeichert</p>
                    </div>
                </div>
            </div>

            <!-- Settings Screen -->
            <div id="settingsScreen" class="screen">
                <div class="header">
                    <div class="logo">‚öôÔ∏è</div>
                    <h1>Systemeinstellungen</h1>
                    <div class="subtitle">Personalisierung und Konfiguration</div>
                </div>
                
                <div class="content-area">
                    <div class="welcome-message">üîß Passen Sie das System an Ihre Bed√ºrfnisse an</div>
                    
                    <!-- Username Change Request -->
                    <div class="user-info">
                        <h3>‚úèÔ∏è Benutzername √§ndern</h3>
                        <div style="margin-bottom: 15px;">
                            <p><strong>Aktueller Benutzername:</strong> <span id="currentUsernameDisplay">Laden...</span></p>
                        </div>
                        <div class="form-group">
                            <label>Neuer gew√ºnschter Benutzername:</label>
                            <input type="text" id="newUsernameRequest" placeholder="Neuer Benutzername" maxlength="20">
                        </div>
                        <div class="form-group">
                            <label>Begr√ºndung f√ºr die √Ñnderung:</label>
                            <textarea id="usernameChangeReason" placeholder="Warum m√∂chten Sie Ihren Benutzernamen √§ndern?" maxlength="300"></textarea>
                        </div>
                        <button onclick="submitUsernameChangeRequest()" style="width: auto; padding: 10px 20px; margin: 0;">üìù Antrag einreichen</button>
                        <div id="usernameChangeError" class="error"></div>
                        <div id="usernameChangeSuccess" class="success"></div>
                    </div>
                    
                    <!-- Dark Mode Setting -->
                    <div class="user-info">
                        <h3>üé® Pers√∂nliche Einstellungen</h3>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px 0;">
                            <div>
                                <strong>Dark Mode (SQL-Datenbank)</strong>
                                <div style="font-size: 13px; color: #666; margin-top: 2px;">Ihre pers√∂nliche Einstellung wird permanent in der SQL-Datenbank f√ºr <strong id="darkModeUser">Ihren Account</strong> gespeichert</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div style="padding: 10px 0; font-size: 12px; color: #888;">
                            üí° <strong>Datenbank-Speicherung:</strong> Ihre Dark Mode Einstellung wird serverseitig gespeichert und ist auf allen Ger√§ten verf√ºgbar. Andere Benutzer sehen ihr eigenes Design.
                        </div>
                    </div>
                    
                    <!-- User Preferences -->
                    <div class="user-info">
                        <h3>üë§ Benutzerinformationen</h3>
                        <p><strong>Benutzername:</strong> <span id="settingsUsername">Laden...</span></p>
                        <p><strong>Vollst√§ndiger Name:</strong> <span id="settingsFullName">Laden...</span></p>
                        <p><strong>Rolle:</strong> <span id="settingsRole">Laden...</span></p>
                        <p><strong>Angemeldet seit:</strong> <span id="settingsLoginTime">Laden...</span></p>
                    </div>
                    
                    <!-- System Info -->
                    <div class="db-info">
                        üìä <strong>Systeminfo:</strong><br>
                        Datenbank: SQLite (government_portal.db)<br>
                        Status: Sicher verschl√ºsselt<br>
                        Letzte Aktivit√§t: <span id="lastActivity">Jetzt</span><br>
                        Dark Mode gespeichert in: <strong>SQL-Datenbank</strong> f√ºr <span id="darkModeStorageInfo">Ihren Account</span>
                    </div>
                </div>
            </div>
            
            <div id="adminDashboard" class="screen">
                <div class="header">
                    <div class="logo">üõ°Ô∏è</div>
                    <h1>Administrationsbereich</h1>
                    <div class="subtitle">Datenbankgest√ºtzte Benutzerverwaltung</div>
                </div>
                
                <div class="content-area">
                    <div class="welcome-message">üõ°Ô∏è Administrator-Zugang best√§tigt</div>
                    
                    <div class="quick-stats">
                        <div class="stat-card">
                            <span class="stat-number" id="statTotalUsers">-</span>
                            <div class="stat-label">Gesamte Benutzer</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="statPendingRegs">-</span>
                            <div class="stat-label">Offene Antr√§ge</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="statActiveUsers">-</span>
                            <div class="stat-label">Aktive Benutzer</div>
                        </div>
                    </div>

                    <div id="pendingSection" class="pending-users">
                        <h3>‚è≥ Offene Zugangsantr√§ge (<span id="pendingCount">0</span>)</h3>
                        <div id="pendingUsersList" class="loading">Lade Daten aus SQL-Datenbank...</div>
                        
                        <!-- Username Change Requests in Pending Section -->
                        <div style="margin-top: 30px;">
                            <h4>‚úèÔ∏è Benutzername-√Ñnderungsantr√§ge</h4>
                            <div id="usernameChangeRequests" class="loading">Lade √Ñnderungsantr√§ge...</div>
                        </div>
                    </div>

                    <div id="allUsersSection" style="display: none;">
                        <h3>üë• SQL-Benutzerverwaltung</h3>
                        <div id="allUsersList" class="loading">Lade Daten aus SQL-Datenbank...</div>
                    </div>

                    <div id="systemLogSection" style="display: none;">
                        <h3>üìú System-Aktivit√§tslog</h3>
                        <div style="margin-bottom: 20px; font-size: 13px; color: #666;">
                            Alle Aktionen von Benutzern mit Vollzugriff werden hier protokolliert.
                        </div>
                        <div id="systemLogList" class="loading">Lade Log-Daten aus SQL-Datenbank...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents Modal -->
    <div id="documentsModal" class="documents-modal">
        <div class="documents-modal-content">
            <div class="documents-modal-header">
                <h2 class="documents-modal-title">üìÑ Dokumentenverwaltung</h2>
                <button class="documents-modal-close" onclick="closeDocumentsModal()">√ó</button>
            </div>
            <div class="documents-modal-body">
                <div class="documents-tabs">
                    <button class="documents-tab active" onclick="switchDocumentsTab('create')">Dokument erstellen</button>
                    <button class="documents-tab" onclick="switchDocumentsTab('view')">Meine Dokumente</button>
                    <button class="documents-tab" onclick="switchDocumentsTab('gdocs')" id="gdocsTabButton" style="display:none">üìù G-Docs Vorlagen</button>
                    <button class="documents-tab" onclick="switchDocumentsTab('templates')" id="templatesTabButton">üìã Frageb√∂gen</button>
                </div>
                
                <div class="documents-content">
                <!-- Create Document Tab -->
<div id="createDocumentTab" class="document-tab-content">
    <h3>Neues Dokument erstellen</h3>
    <div class="document-form">
        <div class="form-group">
            <label>Vollst√§ndiger Name:</label>
            <input type="text" id="docFullName" placeholder="Vor- und Nachname" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
        </div>
        <div class="form-group">
            <label>Datum der sichtung o.√§.:</label>
            <input type="date" id="docBirthDate">
        </div>
        <div class="form-group">
            <label>Ort:</label>
            <input type="text" id="docAddress" placeholder="Ort der Sichtung/des Ereignisses">
        </div>
        <div class="form-group">
            <label>Dienstnummer:</label>
            <input type="text" id="docPhone" placeholder="PD-XY, SD-YZ, FIB-Codename">
        </div>
        <div class="form-group">
            <label>Antragsdatum:</label>
            <input type="date" id="docApplicationDate" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
        </div>
        <div class="form-group full-width">
            <label>Zweck/Begr√ºndung:</label>
            <textarea id="docPurpose" placeholder="Wof√ºr wird das Dokument ben√∂tigt?" rows="3"></textarea>
        </div>
        <div class="form-group full-width">
            <label>Erl√§uterung:</label>
            <textarea id="docAdditional" placeholder="Weitere relevante Informationen (optional)" rows="3"></textarea>
        </div>
    </div>
    <button onclick="createDocument()" style="width: auto; padding: 12px 24px; margin: 0;">üìÑ Dokument erstellen</button>
    <div id="documentCreateError" class="error"></div>
    <div id="documentCreateSuccess" class="success"></div>
</div>

                    <!-- View Documents Tab -->
<div id="viewDocumentsTab" class="document-tab-content" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>üìÑ Dokumente anzeigen</h3>
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
    <!-- Ansicht-Dropdown (Meine/Alle) -->
    <div style="display: flex; align-items: center; gap: 8px;">
        <label for="documentsViewDropdown" style="font-size: 14px; color: #666; margin: 0; white-space: nowrap;">Ansicht:</label>
        <select id="documentsViewDropdown" onchange="onDocumentsViewChange()" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 14px; background: white; min-width: 150px;">
            <option value="my">üìÅ Meine Dokumente</option>
            <option value="all">üóÇÔ∏è Alle Dokumente</option>
        </select>
    </div>
    
    <!-- Template-Filter Dropdown -->
    <div id="templateFilterContainer" style="display: none; align-items: center; gap: 8px;">
        <label for="templateFilterDropdown" style="font-size: 14px; color: #666; margin: 0; white-space: nowrap;">Fragebogen:</label>
        <select id="templateFilterDropdown" onchange="onTemplateFilterChange()" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 14px; background: white; min-width: 180px;">
            <option value="all">üìã Alle Typen</option>
            <option value="manual">üìù Manuell erstellt</option>
            <option value="templates">üóÇÔ∏è Alle Frageb√∂gen</option>
            <!-- Dynamische Optionen werden hier eingef√ºgt -->
        </select>
    </div>
</div>
    
    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 13px; color: #666;">
        <span id="documentsViewInfo">
            üìÅ <strong>Meine Dokumente:</strong> Zeigt nur Ihre eigenen erstellten Dokumente an.
        </span>
    </div>
    
    <div id="documentsListContainer" class="loading">Lade Dokumente...</div>
</div>

                    <!-- G-Docs Admin Tab -->
                    <div id="gdocsTabContent" class="document-tab-content" style="display: none;">
                        <h3>üìù Google Docs Vorlagen verwalten (Admin)</h3>
                        <div class="document-form">
                            <div class="form-group">
                                <label>Vorlagen-Name:</label>
                                <input type="text" id="templateName" placeholder="z.B. Urlaubsantrag, Bewerbung">
                             </div>
                                <div class="form-group">
                                <label>DOCX-Vorlagendatei:</label>
                                <input type="file" id="templateFile" accept=".docx" required>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                Nur .docx Dateien sind erlaubt (max. 10MB)
                                </div>
                             </div>
                            <div class="form-group full-width">
                                <label>Beschreibung:</label>
                                <textarea id="templateDescription" placeholder="Wof√ºr ist diese Vorlage?" rows="2"></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label>Verf√ºgbar f√ºr R√§nge:</label>
                                <div class="gdocs-rank-selector">
                                    <label><input type="checkbox" value="besucher" checked> Besucher</label>
                                    <label><input type="checkbox" value="user" checked> User</label>
                                    <label><input type="checkbox" value="socom-operator" checked> SOCOM</label>
                                    <label><input type="checkbox" value="kabinettsmitglied" checked> Kabinett</label>
                                    <label><input type="checkbox" value="admin" checked> Admin+</label>
                                </div>
                            </div>
                            
                            <!-- Fragebogen-Definition -->
                            <div class="form-group full-width">
                                <label>üìã Fragebogen-Felder definieren:</label>
                                <div id="questionsList" class="questions-container">
                                    <!-- Dynamische Fragen werden hier hinzugef√ºgt -->
                                </div>
                                <button type="button" onclick="addQuestion()" class="btn-secondary" style="width: auto; padding: 8px 16px; margin: 10px 0;">‚ûï Frage hinzuf√ºgen</button>
                            </div>
                        </div>
                        <button onclick="createGdocsTemplate()" style="width: auto; padding: 12px 24px; margin: 0;">üìù Vorlage hinzuf√ºgen</button>
                        <div id="gdocsCreateError" class="error"></div>
                        <div id="gdocsCreateSuccess" class="success"></div>
                        
                        <h4 style="margin-top: 30px;">üìã Vorhandene Vorlagen</h4>
                        <div id="gdocsTemplatesList" class="loading">Lade G-Docs Vorlagen...</div>
                    </div>

                    <!-- Templates/Frageb√∂gen Tab -->
                    <div id="templatesTabContent" class="document-tab-content" style="display: none;">
                        <h3>üìã Verf√ºgbare Frageb√∂gen ausf√ºllen</h3>
                        <div id="availableTemplatesList" class="loading">Lade verf√ºgbare Vorlagen...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Globale Funktionen f√ºr Buttons
        const API_BASE = window.location.hostname === 'localhost' 
    ? 'http://localhost:3000/api'
    : '/api';
        let currentSession = { user: null, loginTime: null, isAdmin: false };
        // Alle Funktionen global verf√ºgbar machen
function makeGlobal() {
    const functions = ['attemptLogin', 'showRegister', 'submitRegistration', 'showLogin', 'logout', 'openDocumentsModal', 'toggleUserDropdown', 'showProfile', 'showSettings', 'backToDashboard', 'loadPendingUsers', 'loadAllUsers', 'loadSystemLog', 'goToHomePage'];
    functions.forEach(fn => {
        if (typeof window[fn] === 'undefined' && typeof eval(fn) === 'function') {
            window[fn] = eval(fn);
        }
    });
}

        // Sichere API-Funktion (KORRIGIERT)
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: { 'Content-Type': 'application/json', ...options.headers },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Erwarte JSON, bekommen: ${contentType}. Response: ${text.substring(0, 100)}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('API Fehler:', error);
                throw error;
            }
        }

        // Event Listeners (KORRIGIERT - jetzt au√üerhalb der apiCall Funktion)
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const activeScreen = document.querySelector('.screen.active');
                if (activeScreen) {
                    if (activeScreen.id === 'loginScreen') {
                        attemptLogin();
                    } else if (activeScreen.id === 'registerScreen') {
                        submitRegistration();
                    }
                }
            }
        });

        // ESC zum Schlie√üen von Modals
        document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const documentsModal = document.getElementById('documentsModal');
        const detailsModal = document.getElementById('documentDetailsModal');
        const editModal = document.getElementById('editDocumentModal');
        
        if (detailsModal) {
            closeDocumentDetailsModal();
        } else if (editModal) {
            closeEditDocumentModal();
        } else if (documentsModal && documentsModal.classList.contains('active')) {
            closeDocumentsModal();
        }
    }
});

        // Fallback Event Listener f√ºr Dokumente-Button
        document.addEventListener('DOMContentLoaded', function() {
            // Backup Event Listener f√ºr den Dokumente-Button
            setTimeout(() => {
                const documentsBtn = document.getElementById('navDocumentsBtn');
                if (documentsBtn) {
                    // Entferne alte Event Listener
                    documentsBtn.removeEventListener('click', openDocumentsModal);
                    // F√ºge neuen Event Listener hinzu
                    documentsBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('üìÑ Dokumente-Button geklickt (Event Listener)');
                        openDocumentsModal();
                    });
                    console.log('üìÑ Backup Event Listener f√ºr Dokumente-Button hinzugef√ºgt');
                }
            }, 1000);
        });

        // Neue Funktion: Zur Homepage navigieren (erweitert)
        function goToHomePage() {
            const hasAdminRights = hasFullAccess(currentSession.user?.rank || 'user');
            
            if (hasAdminRights) {
                showAdminDashboard();
            } else {
                showUserDashboard();
            }
            toggleUserDropdown();
        }

        // Korrigierte attemptLogin Funktion
async function attemptLogin() {
    console.log('üîê attemptLogin() aufgerufen');
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    
    console.log('üë§ Username:', username);
    
    if (!username || !password) {
        showError('loginError', 'Beide Felder sind erforderlich.');
        return;
    }

    try {
        console.log('üì° Sende Login-Request...');
        
        const result = await apiCall('/login', {
            method: 'POST',
            body: JSON.stringify({ username, password })
        });
        
        console.log('‚úÖ Login erfolgreich:', result);

        currentSession.user = result.user;
        currentSession.loginTime = new Date().toLocaleString('de-DE');
        
        const hasAdminRights = hasFullAccess(result.user.rank || 'user');
        currentSession.isAdmin = hasAdminRights;

        if (hasAdminRights) {
            showAdminDashboard();
        } else {
            showUserDashboard();
        }

        clearForm('loginScreen');
        
    } catch (error) {
        console.error('‚ùå Login-Fehler:', error);
        showError('loginError', error.message);
    }
}
// Neue Funktion: Generierte DOCX-Datei herunterladen
async function downloadGeneratedDocx(documentId) {
    console.log('üì• Download generierte DOCX f√ºr Dokument ID:', documentId);
    
    try {
        // Erstelle Download-Link
        const downloadUrl = `${API_BASE}/download-generated/${documentId}`;
        
        // √ñffne Download in neuem Tab/Fenster
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('‚úÖ Download gestartet');
        showTemporaryMessage('üì• Download gestartet...');
        
    } catch (error) {
        console.error('‚ùå Download-Fehler:', error);
        alert(`‚ùå Download-Fehler: ${error.message}`);
    }
}

// Neue Funktion: DOCX-Vorschau anzeigen
async function previewGeneratedDocx(documentId) {
    console.log('üëÅÔ∏è Vorschau f√ºr Dokument ID:', documentId);
    
    try {
        showTemporaryMessage('üìÑ Lade Vorschau...');
        
        const response = await apiCall(`/preview-generated/${documentId}`);
        
        if (response.success) {
            showDocxPreviewModal(response.html, response.documentInfo);
        } else {
            throw new Error(response.error || 'Vorschau konnte nicht geladen werden');
        }
        
    } catch (error) {
        console.error('‚ùå Vorschau-Fehler:', error);
        alert(`‚ùå Vorschau-Fehler: ${error.message}`);
    }
}

// Neue Funktion: DOCX-Vorschau Modal anzeigen
function showDocxPreviewModal(htmlContent, documentInfo) {
    // Entferne bereits vorhandenes Modal falls vorhanden
    const existingModal = document.getElementById('docxPreviewModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const previewModal = document.createElement('div');
    previewModal.className = 'documents-modal active';
    previewModal.id = 'docxPreviewModal';
    
    previewModal.innerHTML = `
        <div class="documents-modal-content" style="max-width: 1200px; height: 90vh;">
            <div class="documents-modal-header">
                <h2 class="documents-modal-title">üëÅÔ∏è DOCX-Vorschau: ${documentInfo.filename || 'Dokument'}</h2>
                <button class="documents-modal-close" onclick="closeDocxPreviewModal()">√ó</button>
            </div>
            <div class="documents-modal-body" style="padding: 20px;">
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <p style="margin: 0;"><strong>Dokument:</strong> ${documentInfo.name} - ${documentInfo.purpose}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;">
                            Erstellt: ${new Date(documentInfo.created).toLocaleString('de-DE')}
                            ${documentInfo.creator ? ` | Ersteller: ${documentInfo.creator}` : ''}
                        </p>
                    </div>
                    <button onclick="downloadGeneratedDocx(${documentInfo.id || 'null'})" class="btn-success" style="width: auto; padding: 8px 16px; margin: 0;">üì• Download DOCX</button>
                </div>
                
                <div style="border: 1px solid #dee2e6; border-radius: 6px; padding: 20px; background: white; overflow-y: auto; max-height: calc(90vh - 200px);">
                    <div style="font-family: 'Times New Roman', serif; line-height: 1.6; color: #333;">
                        ${htmlContent}
                    </div>
                </div>
                
                <div style="margin-top: 15px; text-align: right;">
                    <button onclick="closeDocxPreviewModal()" class="btn-secondary" style="width: auto; padding: 10px 20px;">Schlie√üen</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(previewModal);
    
    // Modal au√üerhalb schlie√üen
    previewModal.addEventListener('click', function(e) {
        if (e.target === previewModal) {
            closeDocxPreviewModal();
        }
    });
}

// Modal schlie√üen
function closeDocxPreviewModal() {
    const modal = document.getElementById('docxPreviewModal');
    if (modal) {
        modal.remove();
    }
}

        // Registrierung
        async function submitRegistration() {
            const userData = {
                username: document.getElementById('newUsername').value.trim(),
                fullName: document.getElementById('fullName').value.trim(),
                password: document.getElementById('newPassword').value.trim(),
                confirmPassword: document.getElementById('confirmPassword').value.trim(),
                reason: document.getElementById('reason').value.trim()
            };

            if (!userData.username || !userData.fullName || !userData.password || !userData.confirmPassword || !userData.reason) {
                showError('registerError', 'Alle Felder m√ºssen ausgef√ºllt werden.');
                return;
            }

            if (userData.password !== userData.confirmPassword) {
                showError('registerError', 'Kennw√∂rter stimmen nicht √ºberein.');
                return;
            }

            try {
                const result = await apiCall('/register', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });

                showSuccess('registerSuccess', `Antrag erfolgreich in SQL-Datenbank gespeichert! (ID: ${result.registrationId})`);
                clearForm('registerScreen');
                setTimeout(() => showLogin(), 3000);
            } catch (error) {
                showError('registerError', error.message);
            }
        }

        // Dashboard-Funktionen (erweitert f√ºr neue R√§nge)
        function showUserDashboard() {
            const currentUserEl = document.getElementById('currentUser');
            const userRoleEl = document.getElementById('userRole');
            const loginTimeEl = document.getElementById('loginTime');
            
            if (currentUserEl && currentSession.user) {
                currentUserEl.textContent = currentSession.user.fullName;
            }
            if (userRoleEl && currentSession.user) {
                const rank = currentSession.user.rank || 'user';
                userRoleEl.textContent = getRankDisplay(rank);
            }
            if (loginTimeEl && currentSession.loginTime) {
                loginTimeEl.textContent = currentSession.loginTime;
            }
            
            const hasAdminRights = hasFullAccess(currentSession.user.rank || 'user');
            showTopNavigation(hasAdminRights);
            showScreen('userDashboard');
            
            loadDarkModePreference();
        }

        // Dropdown-Funktionen f√ºr Dokumentenansicht
function onDocumentsViewChange() {
    console.log('üîÑ Dokumentenansicht wird ge√§ndert...');
    
    const dropdown = document.getElementById('documentsViewDropdown');
    if (!dropdown) {
        console.error('‚ùå Dropdown nicht gefunden!');
        return;
    }
    
    const viewMode = dropdown.value;
    console.log('üìã Neuer View-Modus:', viewMode);
    
    // Template-Filter nur bei "Meine Dokumente" anzeigen
    if (viewMode === 'my') {
        const container = document.getElementById('templateFilterContainer');
        if (container) {
            container.style.display = 'flex';
            // Lade Templates f√ºr Filter
            setTimeout(() => {
                loadAvailableTemplatesForFilter();
            }, 100);
        }
    } else {
        const container = document.getElementById('templateFilterContainer');
        if (container) {
            container.style.display = 'none';
        }
    }
    
    // Info-Text aktualisieren
    updateDocumentsViewInfo(viewMode);
    
    // Dokumente neu laden
    loadUserDocuments();
}
        // Template-Filter Funktionen
function onTemplateFilterChange() {
    console.log('üîÑ Template-Filter wird ge√§ndert...');
    
    const templateFilter = document.getElementById('templateFilterDropdown');
    if (!templateFilter) return;
    
    const filterValue = templateFilter.value;
    console.log('üìã Neuer Template-Filter:', filterValue);
    
    // Dokumente neu laden mit Filter
    loadUserDocuments();
}

async function loadAvailableTemplatesForFilter() {
    try {
        const templates = await apiCall('/available-templates-for-filter');
        updateTemplateFilterOptions(templates);
    } catch (error) {
        console.warn('‚ö†Ô∏è Konnte Template-Filter nicht laden:', error);
    }
}

function updateTemplateFilterOptions(templates) {
    const dropdown = document.getElementById('templateFilterDropdown');
    if (!dropdown) return;
    
    // Behalte die Standard-Optionen
    const standardOptions = `
        <option value="all">üìã Alle Typen</option>
        <option value="manual">üìù Manuell erstellt</option>
        <option value="templates">üóÇÔ∏è Alle Frageb√∂gen</option>
    `;
    
    // F√ºge spezifische Template-Optionen hinzu
    let templateOptions = '';
    if (templates && templates.length > 0) {
        templateOptions = templates.map(template => 
            `<option value="template_${template.id}">üìã ${template.name}</option>`
        ).join('');
    }
    
    dropdown.innerHTML = standardOptions + templateOptions;
    console.log('üìã Template-Filter Optionen aktualisiert:', templates.length, 'Templates');
}

function updateDocumentsViewInfo(viewMode) {
    const infoElement = document.getElementById('documentsViewInfo');
    if (!infoElement) return;
    
    if (viewMode === 'all') {
        infoElement.innerHTML = `
            üóÇÔ∏è <strong>Alle Dokumente:</strong> Zeigt alle Dokumente von allen Benutzern an. 
            Dokumente anderer Benutzer sind blau markiert.
        `;
    } else {
        infoElement.innerHTML = `
            üîí <strong>Meine Dokumente:</strong> Zeigt nur Ihre eigenen erstellten Dokumente an.
        `;
    }
}

function initializeDocumentsDropdown() {
    console.log('üéõÔ∏è Initialisiere Dokumente-Dropdown...');
    
    const dropdown = document.getElementById('documentsViewDropdown');
    if (!dropdown) {
        console.warn('‚ö†Ô∏è Dokumente-Dropdown nicht gefunden');
        return;
    }
    
    // Setze Default-Wert
    dropdown.value = 'my';
    
    // Aktualisiere Info-Text
    updateDocumentsViewInfo('my');
    
    console.log('‚úÖ Dropdown initialisiert');
}

        function showAdminDashboard() {
            const hasAdminRights = hasFullAccess(currentSession.user.rank || 'user');
            
            if (!hasAdminRights) {
                showUserDashboard();
                return;
            }
            
            showTopNavigation(true);
            showScreen('adminDashboard');
            loadPendingUsers();
            loadStats();
            
            loadDarkModePreference();
        }

        // Top Navigation (erweitert)
        function showTopNavigation(isAdmin) {
            const topNav = document.getElementById('topNav');
            const pageWrapper = document.getElementById('pageWrapper');
            
            if (!topNav || !currentSession.user) return;
            
            try {
                const navUserName = document.getElementById('navUserName');
                const navUserRole = document.getElementById('navUserRole');
                const dropdownUserName = document.getElementById('dropdownUserName');
                const dropdownUserFullName = document.getElementById('dropdownUserFullName');
                const dropdownUserRoleText = document.getElementById('dropdownUserRoleText');
                const dropdownLoginTime = document.getElementById('dropdownLoginTime');
                
                if (navUserName) navUserName.textContent = currentSession.user.fullName || 'Unbekannt';
                if (navUserRole) {
                    const userRank = currentSession.user.rank || 'user';
                    const rankDisplay = getRankDisplay(userRank);
                    const rankClass = getRankClass(userRank);
                    
                    navUserRole.textContent = rankDisplay;
                    navUserRole.className = `admin-badge-nav ${rankClass}`;
                }
                if (dropdownUserName) dropdownUserName.textContent = currentSession.user.username || 'Unbekannt';
                if (dropdownUserFullName) dropdownUserFullName.textContent = currentSession.user.fullName || 'Unbekannt';
                if (dropdownUserRoleText) dropdownUserRoleText.textContent = isAdmin ? 'Administrator' : 'Standardbenutzer';
                if (dropdownLoginTime) dropdownLoginTime.textContent = `Angemeldet: ${currentSession.loginTime || '--:--'}`;
                
                const navPendingBtn = document.getElementById('navPendingBtn');
                const navUsersBtn = document.getElementById('navUsersBtn');
                const navLogBtn = document.getElementById('navLogBtn');
                const navDocumentsBtn = document.getElementById('navDocumentsBtn');
                
                // Admin-Buttons
                if (navPendingBtn) navPendingBtn.style.display = isAdmin ? 'block' : 'none';
                if (navUsersBtn) navUsersBtn.style.display = isAdmin ? 'block' : 'none';
                
                // Dokumente-Button f√ºr ALLE Benutzer sichtbar machen
                if (navDocumentsBtn) {
                    navDocumentsBtn.style.display = 'block';
                    console.log('üìÑ Dokumente-Button ist jetzt sichtbar');
                }
                
                const isSystemAdmin = currentSession.user.username === 'admin';
                if (navLogBtn) navLogBtn.style.display = isSystemAdmin ? 'block' : 'none';
                
                topNav.classList.add('active');
                if (pageWrapper) pageWrapper.classList.add('with-nav');
                
            } catch (error) {
                console.error('Navigation Fehler:', error);
            }
        }

        function hideTopNavigation() {
            const topNav = document.getElementById('topNav');
            const pageWrapper = document.getElementById('pageWrapper');
            
            if (topNav) topNav.classList.remove('active');
            if (pageWrapper) pageWrapper.classList.remove('with-nav');
        }

        // Statistiken laden
        async function loadStats() {
            try {
                const stats = await apiCall('/stats');
                
                const statTotalUsers = document.getElementById('statTotalUsers');
                const statPendingRegs = document.getElementById('statPendingRegs');
                const statActiveUsers = document.getElementById('statActiveUsers');
                const pendingCount = document.getElementById('pendingCount');
                
                if (statTotalUsers) statTotalUsers.textContent = stats.totalUsers;
                if (statPendingRegs) statPendingRegs.textContent = stats.pendingRegistrations;
                if (statActiveUsers) statActiveUsers.textContent = stats.activeUsers;
                if (pendingCount) pendingCount.textContent = stats.pendingRegistrations;
                
            } catch (error) {
                console.error('Statistik Fehler:', error);
            }
        }

        // Admin-Funktionen (erweitert)
        async function loadPendingUsers() {
            const hasAdminRights = hasFullAccess(currentSession.user?.rank || 'user');
            if (!hasAdminRights) {
                goToHomePage();
                return;
            }
            
            const pendingSection = document.getElementById('pendingSection');
            const allUsersSection = document.getElementById('allUsersSection');
            const systemLogSection = document.getElementById('systemLogSection');
            
            const currentScreen = document.querySelector('.screen.active');
            if (!currentScreen || currentScreen.id !== 'adminDashboard') {
                showScreen('adminDashboard');
            }
            
            if (allUsersSection) allUsersSection.style.display = 'none';
            if (systemLogSection) systemLogSection.style.display = 'none';
            if (pendingSection) pendingSection.style.display = 'block';
            
            try {
                const pending = await apiCall('/pending-registrations');
                updatePendingUsersList(pending);
                
                await loadUsernameChangeRequests();
                await loadStats();
            } catch (error) {
                const pendingUsersList = document.getElementById('pendingUsersList');
                if (pendingUsersList) {
                    pendingUsersList.innerHTML = `<p style="color: red;">Fehler: ${error.message}</p>`;
                }
            }
        }

        async function loadAllUsers() {
            const hasAdminRights = hasFullAccess(currentSession.user?.rank || 'user');
            if (!hasAdminRights) {
                goToHomePage();
                return;
            }
            
            const pendingSection = document.getElementById('pendingSection');
            const allUsersSection = document.getElementById('allUsersSection');
            const systemLogSection = document.getElementById('systemLogSection');
            
            const currentScreen = document.querySelector('.screen.active');
            if (!currentScreen || currentScreen.id !== 'adminDashboard') {
                showScreen('adminDashboard');
            }
            
            if (pendingSection) pendingSection.style.display = 'none';
            if (systemLogSection) systemLogSection.style.display = 'none';
            if (allUsersSection) allUsersSection.style.display = 'block';
            
            try {
                const users = await apiCall('/users');
                updateAllUsersList(users);
                await loadStats();
            } catch (error) {
                const allUsersList = document.getElementById('allUsersList');
                if (allUsersList) {
                    allUsersList.innerHTML = `<p style="color: red;">Fehler: ${error.message}</p>`;
                }
            }
        }

        function updatePendingUsersList(pending) {
            const container = document.getElementById('pendingUsersList');
            if (!container) return;
            
            if (pending.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Keine offenen Antr√§ge</p>';
                return;
            }

            container.innerHTML = pending.map(reg => `
                <div class="user-card">
                    <h4>${reg.full_name} (${reg.username})</h4>
                    <p><strong>Eingereicht:</strong> ${new Date(reg.created_at).toLocaleString('de-DE')}</p>
                    <p><strong>Begr√ºndung:</strong> ${reg.reason}</p>
                    <span class="status pending">Wartend</span>
                    <div class="user-actions">
                        <button class="btn-success" onclick="approveUser(${reg.id})">‚úÖ Genehmigen</button>
                        <button class="btn-danger" onclick="rejectUser(${reg.id})">‚ùå Ablehnen</button>
                    </div>
                </div>
            `).join('');
        }

        function updateAllUsersList(users) {
            const container = document.getElementById('allUsersList');
            if (!container) return;
            
            container.innerHTML = users.map(user => {
                const rankClass = getRankClass(user.rank || 'user');
                const rankDisplay = getRankDisplay(user.rank || 'user');
                const canManage = canManageUser(user);
                
                return `
                    <div class="user-card">
                        <h4>
                            ${user.full_name} (${user.username})
                            <span class="rank-badge ${rankClass}">${rankDisplay}</span>
                        </h4>
                        <p><strong>Rang:</strong> ${rankDisplay}</p>
                        <p><strong>Erstellt:</strong> ${new Date(user.created_at).toLocaleString('de-DE')}</p>
                        ${user.approved_by ? `<p><strong>Genehmigt von:</strong> ${user.approved_by}</p>` : ''}
                        <span class="status approved">Aktiv</span>
                        
                        ${canManage ? `
                            <div class="rank-selector">
                                <label><strong>Rang √§ndern:</strong></label>
                                <select onchange="updateUserRank(${user.id}, this.value)">
                                    <option value="">-- Rang ausw√§hlen --</option>
                                    <option value="nc-team" ${user.rank === 'nc-team' ? 'selected' : ''}>NC-Team (Vollzugriff)</option>
                                    <option value="president" ${user.rank === 'president' ? 'selected' : ''}>President (Vollzugriff)</option>
                                    <option value="vice-president" ${user.rank === 'vice-president' ? 'selected' : ''}>Vice President (Vollzugriff)</option>
                                    ${currentSession.user.username === 'admin' ? `<option value="admin" ${user.rank === 'admin' ? 'selected' : ''}>Administrator (Vollzugriff)</option>` : ''}
                                    <option value="kabinettsmitglied" ${user.rank === 'kabinettsmitglied' ? 'selected' : ''}>Kabinettsmitglied (Eingeschr√§nkt)</option>
                                    <option value="socom-operator" ${user.rank === 'socom-operator' ? 'selected' : ''}>SOCOM-Operator (Eingeschr√§nkt)</option>
                                    <option value="user" ${user.rank === 'user' ? 'selected' : ''}>Standard User</option>
                                    <option value="besucher" ${user.rank === 'besucher' ? 'selected' : ''}>Besucher</option>
                                </select>
                            </div>
                        ` : ''}
                        
                        <div class="user-actions">
                            ${canManage && user.username !== 'admin' ? `<button class="btn-danger" onclick="deleteUser(${user.id})">üóëÔ∏è Entfernen</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Hilfsfunktionen f√ºr R√§nge
        function getRankClass(rank) {
            const rankClasses = {
                'nc-team': 'rank-nc-team',
                'president': 'rank-president',
                'vice-president': 'rank-vice-president',
                'admin': 'rank-admin',
                'kabinettsmitglied': 'rank-kabinettsmitglied',
                'socom-operator': 'rank-socom-operator',
                'user': 'rank-user',
                'besucher': 'rank-besucher'
            };
            return rankClasses[rank] || 'rank-user';
        }

        function getRankDisplay(rank) {
            const rankDisplays = {
                'nc-team': 'NC-TEAM',
                'president': 'PRESIDENT',
                'vice-president': 'VICE PRESIDENT',
                'admin': 'ADMIN',
                'kabinettsmitglied': 'KABINETT',
                'socom-operator': 'SOCOM',
                'user': 'USER',
                'besucher': 'BESUCHER'
            };
            return rankDisplays[rank] || 'USER';
        }

        function hasFullAccess(rank) {
            const fullAccessRanks = ['nc-team', 'president', 'vice-president', 'admin'];
            return fullAccessRanks.includes(rank);
        }

        function canManageUser(targetUser) {
            if (!currentSession.user) return false;
            
            const currentUserRank = currentSession.user.rank || 'user';
            
            if (currentSession.user.id === targetUser.id) return false;
            
            if (targetUser.username === 'admin' && currentSession.user.username !== 'admin') return false;
            
            if (hasFullAccess(currentUserRank)) return true;
            
            return false;
        }

        // Username Change Request Functions
        async function submitUsernameChangeRequest() {
            const newUsername = document.getElementById('newUsernameRequest').value.trim();
            const reason = document.getElementById('usernameChangeReason').value.trim();
            
            if (!newUsername || !reason) {
                showError('usernameChangeError', 'Alle Felder sind erforderlich.');
                return;
            }
            
            if (newUsername.length < 3 || newUsername.length > 20) {
                showError('usernameChangeError', 'Benutzername muss zwischen 3 und 20 Zeichen haben.');
                return;
            }
            
            try {
                const result = await apiCall('/request-username-change', {
                    method: 'POST',
                    body: JSON.stringify({
                        currentUsername: currentSession.user.username,
                        newUsername: newUsername,
                        reason: reason
                    })
                });
                
                showSuccess('usernameChangeSuccess', 'Antrag erfolgreich eingereicht! Ein Administrator wird Ihren Antrag pr√ºfen.');
                document.getElementById('newUsernameRequest').value = '';
                document.getElementById('usernameChangeReason').value = '';
                
            } catch (error) {
                showError('usernameChangeError', error.message);
            }
        }

        async function loadUsernameChangeRequests() {
            try {
                const requests = await apiCall('/username-change-requests');
                updateUsernameChangeRequestsList(requests);
            } catch (error) {
                const container = document.getElementById('usernameChangeRequests');
                if (container) {
                    container.innerHTML = `<p style="color: red;">Fehler: ${error.message}</p>`;
                }
            }
        }

        function updateUsernameChangeRequestsList(requests) {
            const container = document.getElementById('usernameChangeRequests');
            if (!container) return;
            
            if (requests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">Keine Benutzername-√Ñnderungsantr√§ge</p>';
                return;
            }

            container.innerHTML = requests.map(req => `
                <div class="user-card" style="margin: 10px 0;">
                    <h4>${req.current_username} ‚Üí ${req.new_username}</h4>
                    <p><strong>Eingereicht:</strong> ${new Date(req.created_at).toLocaleString('de-DE')}</p>
                    <p><strong>Begr√ºndung:</strong> ${req.reason}</p>
                    <span class="status pending">Wartend</span>
                    <div class="user-actions">
                        <button class="btn-success" onclick="approveUsernameChange(${req.id})">‚úÖ Genehmigen</button>
                        <button class="btn-danger" onclick="rejectUsernameChange(${req.id})">‚ùå Ablehnen</button>
                    </div>
                </div>
            `).join('');
        }

        async function approveUsernameChange(requestId) {
            try {
                await apiCall(`/approve-username-change/${requestId}`, {
                    method: 'POST',
                    body: JSON.stringify({ adminUsername: currentSession.user.username })
                });
                alert('‚úÖ Benutzername-√Ñnderung genehmigt!');
                await loadUsernameChangeRequests();
                await loadStats();
            } catch (error) {
                alert(`‚ùå Fehler: ${error.message}`);
            }
        }

        async function rejectUsernameChange(requestId) {
            if (!confirm('Benutzername-√Ñnderung wirklich ablehnen?')) return;
            
            try {
                await apiCall(`/reject-username-change/${requestId}`, {
                    method: 'POST',
                    body: JSON.stringify({ adminUsername: currentSession.user.username })
                });
                alert('‚ùå Benutzername-√Ñnderung abgelehnt!');
                await loadUsernameChangeRequests();
            } catch (error) {
                alert(`‚ùå Fehler: ${error.message}`);
            }
        }

        // System Log Functions
        async function loadSystemLog() {
            if (currentSession.user.username !== 'admin') {
                goToHomePage();
                return;
            }
            
            const pendingSection = document.getElementById('pendingSection');
            const allUsersSection = document.getElementById('allUsersSection');
            const systemLogSection = document.getElementById('systemLogSection');
            
            const currentScreen = document.querySelector('.screen.active');
            if (!currentScreen || currentScreen.id !== 'adminDashboard') {
                showScreen('adminDashboard');
            }
            
            if (pendingSection) pendingSection.style.display = 'none';
            if (allUsersSection) allUsersSection.style.display = 'none';
            if (systemLogSection) systemLogSection.style.display = 'block';
            
            try {
                const logs = await apiCall('/system-log');
                updateSystemLogList(logs);
            } catch (error) {
                const systemLogList = document.getElementById('systemLogList');
                if (systemLogList) {
                    systemLogList.innerHTML = `<p style="color: red;">Fehler: ${error.message}</p>`;
                }
            }
        }

        function updateSystemLogList(logs) {
            const container = document.getElementById('systemLogList');
            if (!container) return;
            
            if (logs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Keine Log-Eintr√§ge gefunden</p>';
                return;
            }

            container.innerHTML = logs.map(log => {
                const actionColor = getActionColor(log.action);
                return `
                    <div class="user-card" style="border-left: 4px solid ${actionColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: ${actionColor};">${log.action}</h4>
                            <span style="font-size: 12px; color: #666;">${new Date(log.created_at).toLocaleString('de-DE')}</span>
                        </div>
                        <p><strong>Benutzer:</strong> ${log.performed_by} (${log.user_rank})</p>
                        <p><strong>Details:</strong> ${log.details}</p>
                        ${log.target_user ? `<p><strong>Ziel:</strong> ${log.target_user}</p>` : ''}
                        <div style="font-size: 11px; color: #888; margin-top: 10px;">
                            IP: ${log.ip_address || 'Unbekannt'} | Session: ${log.session_id || 'N/A'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getActionColor(action) {
            const colors = {
                'USER_RANK_UPDATED': '#17a2b8',
                'USER_DELETED': '#dc3545',
                'USER_APPROVED': '#28a745',
                'USER_REJECTED': '#ffc107',
                'USERNAME_CHANGED': '#6f42c1',
                'LOGIN': '#6c757d',
                'SYSTEM_ACCESS': '#fd7e14'
            };
            return colors[action] || '#6c757d';
        }

        // Rang-Update-Funktion (erweitert mit Logging)
        async function updateUserRank(userId, newRank) {
            if (!newRank) return;
            
            if (!confirm(`Rang wirklich zu "${getRankDisplay(newRank)}" √§ndern?`)) return;
            
            try {
                await apiCall(`/update-rank/${userId}`, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        rank: newRank,
                        adminUsername: currentSession.user.username 
                    })
                });
                
                showTemporaryMessage(`‚úÖ Rang erfolgreich zu "${getRankDisplay(newRank)}" ge√§ndert!`);
                await loadAllUsers();
            } catch (error) {
                alert(`‚ùå Fehler beim Rang-Update: ${error.message}`);
                await loadAllUsers();
            }
        }

        async function approveUser(regId) {
            try {
                await apiCall(`/approve-registration/${regId}`, {
                    method: 'POST',
                    body: JSON.stringify({ adminUsername: currentSession.user.username })
                });
                alert('‚úÖ Benutzer genehmigt!');
                await loadPendingUsers();
            } catch (error) {
                alert(`‚ùå Fehler: ${error.message}`);
            }
        }

        async function rejectUser(regId) {
            if (!confirm('Antrag wirklich ablehnen?')) return;
            
            try {
                await apiCall(`/reject-registration/${regId}`, {
                    method: 'POST',
                    body: JSON.stringify({ adminUsername: currentSession.user.username })
                });
                alert('‚ùå Antrag abgelehnt!');
                await loadPendingUsers();
            } catch (error) {
                alert(`‚ùå Fehler: ${error.message}`);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Benutzer wirklich l√∂schen?')) return;
            
            try {
                await apiCall(`/users/${userId}`, {
                    method: 'DELETE',
                    body: JSON.stringify({ adminUsername: currentSession.user.username })
                });
                alert('üóëÔ∏è Benutzer entfernt!');
                await loadAllUsers();
            } catch (error) {
                alert(`‚ùå Fehler: ${error.message}`);
            }
        }

        // Dropdown-Funktionen
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdownMenu');
            const toggle = document.querySelector('.dropdown-toggle');
            
            if (dropdown && toggle) {
                const isActive = dropdown.classList.contains('active');
                
                if (isActive) {
                    dropdown.classList.remove('active');
                    toggle.classList.remove('active');
                } else {
                    dropdown.classList.add('active');
                    toggle.classList.add('active');
                }
            }
        }

        function showProfile() {
            alert('Profil-Funktion wird implementiert...');
            toggleUserDropdown();
        }

        // Dark Mode Funktionen (benutzerbasiert)
        async function toggleDarkMode() {
            if (!currentSession.user) return;
            
            const isDark = document.body.classList.contains('dark');
            const newDarkMode = !isDark;
            
            if (newDarkMode) {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
            
            const toggle = document.getElementById('darkModeToggle');
            if (toggle) toggle.checked = newDarkMode;
            
            try {
                await apiCall('/update-dark-mode', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        username: currentSession.user.username, 
                        darkMode: newDarkMode 
                    })
                });
                
                const message = newDarkMode ? 'üåô Dark Mode aktiviert' : '‚òÄÔ∏è Light Mode aktiviert';
                showTemporaryMessage(message + ` und in der Datenbank f√ºr ${currentSession.user.username} gespeichert`);
                
            } catch (error) {
                console.error('Dark Mode Speicher-Fehler:', error);
                
                const userKey = `darkMode_${currentSession.user.username}`;
                localStorage.setItem(userKey, newDarkMode ? 'enabled' : 'disabled');
                
                const message = newDarkMode ? 'üåô Dark Mode aktiviert' : '‚òÄÔ∏è Light Mode aktiviert';
                showTemporaryMessage(message + ` (lokal f√ºr ${currentSession.user.username} gespeichert)`);
            }
        }

        async function loadDarkModePreference() {
            if (!currentSession.user) return;
            
            let isDark = false;
            
            try {
                const result = await apiCall(`/dark-mode/${currentSession.user.username}`);
                isDark = result.darkMode;
                
            } catch (error) {
                console.error('Dark Mode Load-Fehler (verwende LocalStorage):', error);
                
                const userKey = `darkMode_${currentSession.user.username}`;
                const storedMode = localStorage.getItem(userKey);
                isDark = storedMode === 'enabled';
            }
            
            if (isDark) {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
            
            const toggle = document.getElementById('darkModeToggle');
            if (toggle) toggle.checked = isDark;
        }

        function clearUserDarkModeOnLogout() {
            document.body.classList.remove('dark');
        }

        function showTemporaryMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: rgba(106, 76, 147, 0.95);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 9999;
                font-weight: 500;
                backdrop-filter: blur(10px);
                animation: slideIn 0.3s ease;
                max-width: 300px;
                font-size: 14px;
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => messageDiv.remove(), 300);
            }, 3000);
        }

        // Settings (erweitert ohne Navigation Buttons)
        function showSettings() {
            const settingsUsername = document.getElementById('settingsUsername');
            const settingsFullName = document.getElementById('settingsFullName');
            const settingsEmail = document.getElementById('settingsEmail');
            const settingsRole = document.getElementById('settingsRole');
            const settingsLoginTime = document.getElementById('settingsLoginTime');
            const lastActivity = document.getElementById('lastActivity');
            const darkModeUser = document.getElementById('darkModeUser');
            const darkModeStorageInfo = document.getElementById('darkModeStorageInfo');
            const currentUsernameDisplay = document.getElementById('currentUsernameDisplay');
            
            if (currentSession.user) {
                if (settingsUsername) settingsUsername.textContent = currentSession.user.username;
                if (settingsFullName) settingsFullName.textContent = currentSession.user.fullName;
                if (settingsRole) settingsRole.textContent = getRankDisplay(currentSession.user.rank || 'user');
                if (settingsLoginTime) settingsLoginTime.textContent = currentSession.loginTime;
                if (lastActivity) lastActivity.textContent = new Date().toLocaleString('de-DE');
                if (darkModeUser) darkModeUser.textContent = currentSession.user.username;
                if (darkModeStorageInfo) darkModeStorageInfo.textContent = currentSession.user.username;
                if (currentUsernameDisplay) currentUsernameDisplay.textContent = currentSession.user.username;
            }
            
            loadDarkModePreference();
            
            showScreen('settingsScreen');
            toggleUserDropdown();
        }

        function backToDashboard() {
            goToHomePage();
        }

        // Screen Management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
        }

        function showLogin() {
            hideTopNavigation();
            showScreen('loginScreen');
        }

        function showRegister() {
            hideTopNavigation();
            showScreen('registerScreen');
        }

        function logout() {
            if (confirm('Wirklich abmelden?')) {
                clearUserDarkModeOnLogout();
                
                currentSession = { user: null, loginTime: null, isAdmin: false };
                hideTopNavigation();
                showLogin();
                clearAllForms();
                toggleUserDropdown();
            }
        }

        // Utility Functions
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                setTimeout(() => element.textContent = '', 5000);
            }
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                setTimeout(() => element.textContent = '', 5000);
            }
        }

        function clearForm(screenId) {
            document.querySelectorAll(`#${screenId} input, #${screenId} textarea`).forEach(input => {
                if (input) input.value = '';
            });
            document.querySelectorAll(`#${screenId} .error, #${screenId} .success`).forEach(msg => {
                if (msg) msg.textContent = '';
            });
        }

        function clearAllForms() {
            document.querySelectorAll('input, textarea').forEach(input => {
                if (input) input.value = '';
            });
            document.querySelectorAll('.error, .success').forEach(msg => {
                if (msg) msg.textContent = '';
            });
        }

        // Documents Modal Functions
        let documentsModalReturnScreen = null;

        function openDocumentsModal() {
    console.log('üîç Dokumente-Modal wird ge√∂ffnet...');
    
    // Aktuelle Screen merken f√ºr R√ºckkehr
    const currentScreen = document.querySelector('.screen.active');
    if (currentScreen) {
        documentsModalReturnScreen = currentScreen.id;
        console.log('üìç Aktuelle Screen:', currentScreen.id);
    }
    
    const modal = document.getElementById('documentsModal');
    console.log('üéØ Modal gefunden:', modal ? 'Ja' : 'Nein');
    
    if (modal) {
        modal.classList.add('active');
        console.log('‚úÖ Modal aktiviert');
        
        // G-Docs Tab nur f√ºr Admins anzeigen
        const gdocsTabButton = document.getElementById('gdocsTabButton');
        if (gdocsTabButton && currentSession.user) {
            const hasAdminRights = hasFullAccess(currentSession.user.rank || 'user');
            gdocsTabButton.style.display = hasAdminRights ? 'block' : 'none';
            console.log('üìù G-Docs Tab f√ºr Admin:', hasAdminRights ? 'Sichtbar' : 'Versteckt');
            console.log('üë§ Benutzer-Rang:', currentSession.user.rank, '| Admin-Rechte:', hasAdminRights);
        } else {
            console.warn('‚ö†Ô∏è G-Docs Tab Button nicht gefunden oder kein Benutzer angemeldet');
        }
        
        // Auto-fill user data
        console.log('üìù F√ºlle Benutzerdaten aus...');
        prefillUserData();
        
        // Initialisiere Dropdown
        setTimeout(() => {
            initializeDocumentsDropdown();
        }, 100);
        
        // Load initial content based on active tab
        const activeTab = document.querySelector('.documents-tab.active');
        if (activeTab) {
            const tabText = activeTab.textContent.trim();
            console.log('üîç Aktiver Tab:', tabText);
            
            if (tabText.includes('Meine Dokumente')) {
                loadUserDocuments();
            } else if (tabText.includes('G-Docs Vorlagen')) {
                loadGdocsTemplates();
            } else if (tabText.includes('Frageb√∂gen')) {
                loadAvailableTemplates();
            } else {
                // Default: Create Tab ist aktiv, lade nichts
                console.log('‚ÑπÔ∏è Create Tab ist aktiv, lade keine Daten');
            }
        } else {
            console.log('‚ö†Ô∏è Kein aktiver Tab gefunden');
        }
        
        console.log('üéâ Modal-Setup abgeschlossen!');
    } else {
        console.error('‚ùå Modal nicht gefunden!');
        alert('Fehler: Dokumente-Modal nicht gefunden!');
    }
}

        function closeDocumentsModal() {
            const modal = document.getElementById('documentsModal');
            if (modal) {
                modal.classList.remove('active');
            }
            
            // Zur√ºck zur vorherigen Screen
            if (documentsModalReturnScreen) {
                const returnScreen = document.getElementById(documentsModalReturnScreen);
                if (returnScreen) {
                    showScreen(documentsModalReturnScreen);
                }
            }
        }

        function switchDocumentsTab(tabName) {
            console.log('üîÑ Wechsele zu Tab:', tabName);
            
            // Tab buttons
            document.querySelectorAll('.documents-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Den aktiven Tab finden und markieren
            const activeTabButton = document.querySelector(`.documents-tab[onclick*="'${tabName}'"]`);
            if (activeTabButton) {
                activeTabButton.classList.add('active');
                console.log('‚úÖ Tab-Button aktiviert:', tabName);
            } else {
                console.warn('‚ö†Ô∏è Tab-Button nicht gefunden f√ºr:', tabName);
            }
            
            // Alle Tab-Inhalte verstecken
            const tabContents = [
                'createDocumentTab', 
                'viewDocumentsTab', 
                'gdocsTabContent', 
                'templatesTabContent'
            ];
            
            tabContents.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) {
                    tab.style.display = 'none';
                    console.log('üôà Tab versteckt:', tabId);
                }
            });
            
            // Aktiven Tab anzeigen - verschiedene ID-Mappings versuchen
            let activeTabContent = null;
            
            if (tabName === 'create') {
                activeTabContent = document.getElementById('createDocumentTab');
            } else if (tabName === 'view') {
    activeTabContent = document.getElementById('viewDocumentsTab');
    // Dropdown-Status zur√ºcksetzen wenn View-Tab ge√∂ffnet wird
    const dropdown = document.getElementById('documentsViewDropdown');
    if (dropdown && dropdown.value === '') {
        dropdown.value = 'my'; // Default zu "Meine Dokumente"
    }
            } else if (tabName === 'gdocs') {
                activeTabContent = document.getElementById('gdocsTabContent');
                // F√ºge Standard-Frage hinzu wenn noch keine vorhanden
                if (questionCounter === 0) {
                    addQuestion();
                }
            } else if (tabName === 'templates') {
                activeTabContent = document.getElementById('templatesTabContent');
            }
            
            if (activeTabContent) {
                activeTabContent.style.display = 'block';
                console.log('‚úÖ Tab-Content angezeigt:', activeTabContent.id);
            } else {
                console.error('‚ùå Tab-Content nicht gefunden f√ºr:', tabName);
            }
            
            // Tab-spezifische Aktionen
            if (tabName === 'view') {
                loadUserDocuments();
            } else if (tabName === 'gdocs') {
                loadGdocsTemplates();
            } else if (tabName === 'templates') {
                loadAvailableTemplates();
            }
        }

        function prefillUserData() {
            if (!currentSession.user) return;
            
            const docFullName = document.getElementById('docFullName');
            const docApplicationDate = document.getElementById('docApplicationDate');
            
            if (docFullName) docFullName.value = currentSession.user.fullName || '';
            if (docApplicationDate) docApplicationDate.value = new Date().toISOString().split('T')[0];
        }

        async function createDocument() {
            console.log('üìù createDocument() gestartet');
            
            const documentData = {
                fullName: document.getElementById('docFullName').value.trim(),
                birthDate: document.getElementById('docBirthDate').value,
                address: document.getElementById('docAddress').value.trim(),
                phone: document.getElementById('docPhone').value.trim(),
                purpose: document.getElementById('docPurpose').value.trim(),
                applicationDate: document.getElementById('docApplicationDate').value,
                additional: document.getElementById('docAdditional').value.trim(),
                createdBy: currentSession.user.username
            };

            console.log('üìã Dokument-Daten gesammelt:', documentData);

            // Validation
            if (!documentData.fullName || !documentData.purpose) {
                const errorMsg = ('Name und Zweck sind erforderlich.');
                console.error('‚ùå Validierung fehlgeschlagen:', errorMsg);
                showError('documentCreateError', errorMsg);
                return;
            }

            console.log('‚úÖ Validierung erfolgreich, sende an Server...');

            try {
                const result = await apiCall('/create-document', {
                    method: 'POST',
                    body: JSON.stringify(documentData)
                });

                console.log('‚úÖ Server-Antwort erhalten:', result);
                showSuccess('documentCreateSuccess', `Dokument erfolgreich erstellt! (ID: ${result.documentId})`);
                
                // Form zur√ºcksetzen
                console.log('üßπ Setze Formular zur√ºck...');
                document.querySelectorAll('#createDocumentTab input, #createDocumentTab textarea').forEach(input => {
                    if (input.type !== 'email' && input.id !== 'docFullName' && input.id !== 'docApplicationDate') {
                        input.value = '';
                    }
                });
                
                // Dokumente neu laden falls auf View-Tab
                console.log('üîÑ Pr√ºfe ob Dokumente neu geladen werden m√ºssen...');
                const viewTab = document.getElementById('viewDocumentsTab');
                if (viewTab && viewTab.style.display !== 'none') {
                    console.log('üîÑ Lade Dokumente neu, da View-Tab aktiv ist...');
                    loadUserDocuments();
                } else {
                    console.log('‚ÑπÔ∏è View-Tab ist nicht aktiv, lade nicht neu');
                }

            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen des Dokuments:', error);
                showError('documentCreateError', error.message);
            }
        }

        async function loadUserDocuments() {
    console.log('üìÑ loadUserDocuments() gestartet');
    
    if (!currentSession.user) {
        console.error('‚ùå Kein Benutzer f√ºr Dokumente angemeldet!');
        return;
    }
    
    const container = document.getElementById('documentsListContainer');
    if (!container) {
        console.error('‚ùå documentsListContainer nicht gefunden!');
        return;
    }
    
    // Pr√ºfe Dropdown-Auswahl
    const dropdown = document.getElementById('documentsViewDropdown');
    const viewMode = dropdown ? dropdown.value : 'my';
    
    console.log('üì¶ Dokumente-Container gefunden, View-Modus:', viewMode);
    console.log('üë§ Benutzer:', currentSession.user.username);
    
    if (viewMode === 'all') {
        container.innerHTML = '<div class="loading">Lade alle Dokumente aus SQL-Datenbank...</div>';
    } else {
        container.innerHTML = '<div class="loading">Lade meine Dokumente aus SQL-Datenbank...</div>';
    }
    
    try {
        let apiUrl, documents;
        
        if (viewMode === 'all') {
            // Lade alle Dokumente
            apiUrl = '/all-documents';
            console.log('üîó API-Aufruf f√ºr alle Dokumente:', apiUrl);
            documents = await apiCall(apiUrl);
        } else {
            // Lade nur Benutzer-Dokumente
            apiUrl = `/documents/${currentSession.user.username}`;
            console.log('üîó API-Aufruf f√ºr Benutzer-Dokumente:', apiUrl);
            documents = await apiCall(apiUrl);
        }
        
        console.log('üìÑ Dokumente von API erhalten:', documents);
        console.log('üìä Anzahl Dokumente:', documents ? documents.length : 'undefined');
        
        updateDocumentsList(documents, viewMode);
    } catch (error) {
        console.error('‚ùå Fehler beim Laden der Dokumente:', error);
        container.innerHTML = `<p style="color: red;">Fehler beim Laden: ${error.message}</p>`;
    }
}

// === DOKUMENT-VORSCHAU F√úR ALLE BENUTZER ===
function viewDocumentDetails(docId) {
    console.log('üëÅÔ∏è Zeige Dokument-Details f√ºr ID:', docId);
    
    if (!docId || isNaN(docId)) {
        alert('‚ùå Ung√ºltige Dokument-ID');
        return;
    }
    
    // Lade Dokument-Details vom Server
    loadDocumentDetails(docId);
}

async function loadDocumentDetails(docId) {
    try {
        console.log('üìÑ Lade Dokument-Details f√ºr ID:', docId);
        const document = await apiCall(`/document/${docId}`);
        console.log('üìÑ Dokument-Details erhalten:', document);
        
        showDocumentDetailsModal(document);
        
    } catch (error) {
        console.error('‚ùå Fehler beim Laden der Dokument-Details:', error);
        alert(`Fehler beim Laden der Details: ${error.message}`);
    }
}

// ‚úÖ KORRIGIERTE Frontend-Funktionen f√ºr index.html

// Hilfsfunktion: Rang-Anzeige (Frontend-Version)
function getRankDisplay(rank) {
    const rankDisplays = {
        'nc-team': 'NC-TEAM',
        'president': 'PRESIDENT', 
        'vice-president': 'VICE PRESIDENT',
        'admin': 'ADMIN',
        'kabinettsmitglied': 'KABINETT',
        'socom-operator': 'SOCOM',
        'user': 'USER',
        'besucher': 'BESUCHER'
    };
    return rankDisplays[rank] || 'USER';
}

function showDocumentDetailsModal(documentData) {
    // Entferne bereits vorhandenes Modal falls vorhanden
    const existingModal = document.getElementById('documentDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const detailsModal = document.createElement('div');
    detailsModal.className = 'documents-modal active';
    detailsModal.id = 'documentDetailsModal';
    
    // Template-Antworten formatieren (falls vorhanden)
    let templateInfo = '';
    if (documentData.template_answers) {
        try {
            const answers = JSON.parse(documentData.template_answers);
            templateInfo = `
                <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 6px; border-left: 4px solid #17a2b8;">
                    <h4 style="margin: 0 0 10px 0; color: #17a2b8;">üìã Fragebogen-Antworten</h4>
                    <p><strong>Vorlage:</strong> ${documentData.template_name || 'Unbekannt'}</p>
                    ${documentData.template_description ? `<p><strong>Beschreibung:</strong> ${documentData.template_description}</p>` : ''}
                    <div style="margin-top: 10px;">
                        ${Object.entries(answers).map(([key, value]) => `
                            <p style="margin: 5px 0;"><strong>${key}:</strong> ${Array.isArray(value) ? value.join(', ') : value}</p>
                        `).join('')}
                    </div>
                </div>
            `;
        } catch (e) {
            templateInfo = `
                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 6px;">
                    <p><strong>üìã Fragebogen-Daten:</strong> Vorhanden, aber nicht lesbar</p>
                </div>
            `;
        }
    }
    
    // Ersteller-Info (erweitert)
    const creatorInfo = documentData.creator_full_name ? `
        <p><strong>Erstellt von:</strong> ${documentData.creator_full_name} (${documentData.created_by})
           ${documentData.creator_rank ? `<span class="rank-badge rank-${documentData.creator_rank}">${getRankDisplay(documentData.creator_rank)}</span>` : ''}
        </p>
        ${documentData.creator_email ? `<p><strong>Ersteller E-Mail:</strong> ${documentData.creator_email}</p>` : ''}
    ` : `<p><strong>Erstellt von:</strong> ${documentData.created_by}</p>`;
    
    // Dokument-Typ Badge
    const typeBadge = documentData.document_type === 'template' 
        ? '<span style="background: #17a2b8; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;">üìã FRAGEBOGEN</span>'
        : '<span style="background: #6c757d; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;">üìù MANUELL</span>';
    
    // ‚úÖ SICHERHEITSPR√úFUNG f√ºr currentSession
    const isOwnDocument = currentSession && currentSession.user && documentData.created_by === currentSession.user.username;
    const actionButtons = isOwnDocument ? `
        <button onclick="editDocumentFromDetails(${documentData.id})" class="btn-warning" style="width: auto; padding: 10px 20px; margin-left: 10px;">‚úèÔ∏è Bearbeiten</button>
        <button onclick="deleteDocumentFromDetails(${documentData.id})" class="btn-danger" style="width: auto; padding: 10px 20px; margin-left: 10px;">üóëÔ∏è L√∂schen</button>
    ` : '';
    
    detailsModal.innerHTML = `
        <div class="documents-modal-content">
            <div class="documents-modal-header">
                <h2 class="documents-modal-title">üëÅÔ∏è Dokument-Details</h2>
                <button class="documents-modal-close" onclick="closeDocumentDetailsModal()">√ó</button>
            </div>
            <div class="documents-modal-body">
                <div style="margin-bottom: 20px; text-align: center;">
                    ${typeBadge}
                </div>
                
                <div class="document-item" style="margin: 0; box-shadow: none; border: 1px solid #e0e0e0;">
                    <div class="document-date">Erstellt: ${new Date(documentData.created_at).toLocaleString('de-DE')}</div>
                    <div class="document-title" style="font-size: 20px; margin-bottom: 15px;">${documentData.full_name} - ${documentData.purpose}</div>
                    <div class="document-details">
                        ${creatorInfo}
                        ${documentData.birth_date ? `<p><strong>Geburtsdatum:</strong> ${new Date(documentData.birth_date).toLocaleDateString('de-DE')}</p>` : ''}
                        ${documentData.address ? `<p><strong>Adresse:</strong> ${documentData.address}</p>` : ''}
                        ${documentData.phone ? `<p><strong>Telefon:</strong> ${documentData.phone}</p>` : ''}
                        ${documentData.application_date ? `<p><strong>Antragsdatum:</strong> ${new Date(documentData.application_date).toLocaleDateString('de-DE')}</p>` : ''}
                        ${documentData.additional_info ? `<p><strong>Zus√§tzliche Informationen:</strong><br>${documentData.additional_info.replace(/\n/g, '<br>')}</p>` : ''}
                    </div>
                    
                    ${templateInfo}
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="closeDocumentDetailsModal()" class="btn-secondary" style="width: auto; padding: 10px 20px;">Schlie√üen</button>
                    ${actionButtons}
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(detailsModal);
    
    // Modal au√üerhalb schlie√üen
    detailsModal.addEventListener('click', function(e) {
        if (e.target === detailsModal) {
            closeDocumentDetailsModal();
        }
    });
}

function closeDocumentDetailsModal() {
    const modal = document.getElementById('documentDetailsModal');
    if (modal) {
        modal.remove();
    }
}

function editDocumentFromDetails(docId) {
    closeDocumentDetailsModal();
    editDocument(docId);
}

async function deleteDocumentFromDetails(docId) {
    const confirmed = confirm('Dokument wirklich l√∂schen?');
    if (!confirmed) return;
    
    try {
        // ‚úÖ PR√úFE ob apiCall existiert
        if (typeof apiCall === 'undefined') {
            console.error('‚ùå apiCall Funktion nicht gefunden!');
            alert('‚ùå Fehler: API-Funktion nicht verf√ºgbar');
            return;
        }
        
        await apiCall(`/documents/${docId}`, {
            method: 'DELETE'
        });
        
        alert('üóëÔ∏è Dokument erfolgreich gel√∂scht!');
        closeDocumentDetailsModal();
        loadUserDocuments(); // Aktualisiere die Liste
        
    } catch (error) {
        alert(`‚ùå Fehler beim L√∂schen: ${error.message}`);
    }
}

// ‚úÖ KORRIGIERTE updateDocumentsList mit DOCX-Support
function updateDocumentsList(documents, viewMode = 'my') {
    console.log('üìã updateDocumentsList() gestartet mit:', documents, 'View-Modus:', viewMode);
    
    const container = document.getElementById('documentsListContainer');
    if (!container) {
        console.error('‚ùå documentsListContainer in updateDocumentsList nicht gefunden!');
        return;
    }
    
    if (!documents) {
        console.warn('‚ö†Ô∏è Keine Dokumente √ºbergeben (undefined/null)');
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Fehler: Keine Daten erhalten</p>';
        return;
    }
    
    if (documents.length === 0) {
        const emptyMessage = viewMode === 'all' 
            ? 'Noch keine Dokumente im System vorhanden' 
            : 'Noch keine eigenen Dokumente erstellt';
        console.log('üî≠', emptyMessage);
        container.innerHTML = `<p style="text-align: center; color: #666; padding: 40px;">${emptyMessage}</p>`;
        return;
    }

    console.log('üìÑ Erstelle HTML f√ºr', documents.length, 'Dokumente');
    
    const documentsHtml = documents.map((doc, index) => {
        console.log(`üìÑ Dokument ${index + 1}:`, doc);
        
        // ‚úÖ SICHERHEITSPR√úFUNG f√ºr currentSession
        const currentUsername = currentSession && currentSession.user ? currentSession.user.username : null;
        
        // Zus√§tzliche Anzeige f√ºr "Alle Dokumente" Modus
        const creatorInfo = viewMode === 'all' && doc.created_by !== currentUsername 
            ? `<p><strong>Erstellt von:</strong> <span style="color: #6a4c93; font-weight: 600;">${doc.created_by}</span></p>` 
            : '';
        
        // Zeige verschiedene Aktionen basierend auf Berechtigung
        const isOwnDocument = doc.created_by === currentUsername;
        const canEdit = isOwnDocument;
        const canDelete = isOwnDocument;
        
        // DOCX Download & Vorschau Buttons
        const docxButtons = doc.generated_docx_path ? `
            <button class="btn-success" onclick="downloadGeneratedDocx(${doc.id})" title="Generierte DOCX-Datei herunterladen">üì• DOCX Download</button>
            <button class="btn-secondary" onclick="previewGeneratedDocx(${doc.id})" title="DOCX-Vorschau anzeigen">üëÅÔ∏è Vorschau</button>
        ` : '';
        
        const actionButtons = `
            <button class="btn-secondary" onclick="viewDocumentDetails(${doc.id})">üëÅÔ∏è Details</button>
            ${docxButtons}
            ${canEdit ? `<button class="btn-warning" onclick="editDocument(${doc.id})">‚úèÔ∏è Bearbeiten</button>` : ''}
            ${canDelete ? `<button class="btn-danger" onclick="deleteDocument(${doc.id})">üóëÔ∏è L√∂schen</button>` : ''}
        `;
        
        // Document-Type Badge mit DOCX-Indikator
        let typeBadge = '';
        if (doc.document_type === 'template') {
            typeBadge = '<span style="background: #17a2b8; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-left: 10px;">üìã FRAGEBOGEN</span>';
            if (doc.generated_docx_path) {
                typeBadge += '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-left: 5px;">üìÑ DOCX</span>';
            }
        } else {
            typeBadge = '<span style="background: #6c757d; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-left: 10px;">üìù MANUELL</span>';
        }
        
        // DOCX-Info anzeigen falls vorhanden
        const docxInfo = doc.generated_docx_path ? `
            <p><strong>Generierte Datei:</strong> 
                <span style="color: #28a745; font-weight: 600;">${doc.generated_filename || 'Verf√ºgbar'}</span>
                <span style="font-size: 11px; background: #d4edda; color: #155724; padding: 2px 6px; border-radius: 3px; margin-left: 8px;">
                    üìÑ DOCX verf√ºgbar
                </span>
            </p>
        ` : '';
        
        return `
            <div class="document-item" style="${!isOwnDocument ? 'border-left: 4px solid #17a2b8;' : ''}">
                <div class="document-date">Erstellt: ${new Date(doc.created_at).toLocaleString('de-DE')}</div>
                <div class="document-title">
                    ${doc.full_name} - ${doc.purpose}
                    ${typeBadge}
                </div>
                <div class="document-details">
                    ${creatorInfo}
                    ${doc.birth_date ? `<p><strong>Geburtsdatum:</strong> ${new Date(doc.birth_date).toLocaleDateString('de-DE')}</p>` : ''}
                    ${doc.address ? `<p><strong>Adresse:</strong> ${doc.address}</p>` : ''}
                    ${doc.phone ? `<p><strong>Telefon:</strong> ${doc.phone}</p>` : ''}
                    ${doc.application_date ? `<p><strong>Antragsdatum:</strong> ${new Date(doc.application_date).toLocaleDateString('de-DE')}</p>` : ''}
                    ${doc.additional_info ? `<p><strong>Zus√§tzliche Infos:</strong> ${doc.additional_info}</p>` : ''}
                    ${docxInfo}
                </div>
                <div class="document-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
                    ${actionButtons}
                </div>
            </div>
        `;
    }).join('');

    console.log('‚úÖ HTML erstellt, f√ºge in Container ein...');
    container.innerHTML = documentsHtml;
    console.log('‚úÖ Dokumente-Liste aktualisiert!');
}

// Neue Funktion: Generierte DOCX-Datei herunterladen
async function downloadGeneratedDocx(documentId) {
    // ... (kompletter Code aus paste.txt)
}

// Neue Funktion: DOCX-Vorschau anzeigen  
async function previewGeneratedDocx(documentId) {
    // ... (kompletter Code aus paste.txt)
}

// Neue Funktion: DOCX-Vorschau Modal anzeigen
function showDocxPreviewModal(htmlContent, documentInfo) {
    // ... (kompletter Code aus paste.txt)
}

// Modal schlie√üen
function closeDocxPreviewModal() {
    // ... (kompletter Code aus paste.txt)
}

// Neue Funktion: Generierte DOCX-Datei herunterladen
async function downloadGeneratedDocx(documentId) {
    console.log('üì• Download generierte DOCX f√ºr Dokument ID:', documentId);
    
    try {
        // Erstelle Download-Link
        const downloadUrl = `${API_BASE}/download-generated/${documentId}`;
        
        // √ñffne Download in neuem Tab/Fenster
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('‚úÖ Download gestartet');
        showTemporaryMessage('üì• Download gestartet...');
        
    } catch (error) {
        console.error('‚ùå Download-Fehler:', error);
        alert(`‚ùå Download-Fehler: ${error.message}`);
    }
}

// Neue Funktion: DOCX-Vorschau anzeigen
async function previewGeneratedDocx(documentId) {
    console.log('üëÅÔ∏è Vorschau f√ºr Dokument ID:', documentId);
    
    try {
        showTemporaryMessage('üîÑ Lade Vorschau...');
        
        const response = await apiCall(`/preview-generated/${documentId}`);
        
        if (response.success) {
            showDocxPreviewModal(response.html, response.documentInfo);
        } else {
            throw new Error(response.error || 'Vorschau konnte nicht geladen werden');
        }
        
    } catch (error) {
        console.error('‚ùå Vorschau-Fehler:', error);
        alert(`‚ùå Vorschau-Fehler: ${error.message}`);
    }
}

// Neue Funktion: DOCX-Vorschau Modal anzeigen
function showDocxPreviewModal(htmlContent, documentInfo) {
    // Entferne bereits vorhandenes Modal falls vorhanden
    const existingModal = document.getElementById('docxPreviewModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const previewModal = document.createElement('div');
    previewModal.className = 'documents-modal active';
    previewModal.id = 'docxPreviewModal';
    
    previewModal.innerHTML = `
        <div class="documents-modal-content" style="max-width: 1200px; height: 90vh;">
            <div class="documents-modal-header">
                <h2 class="documents-modal-title">üëÅÔ∏è DOCX-Vorschau: ${documentInfo.filename || 'Dokument'}</h2>
                <button class="documents-modal-close" onclick="closeDocxPreviewModal()">√ó</button>
            </div>
            <div class="documents-modal-body" style="padding: 20px;">
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <p style="margin: 0;"><strong>Dokument:</strong> ${documentInfo.name} - ${documentInfo.purpose}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;">
                            Erstellt: ${new Date(documentInfo.created).toLocaleString('de-DE')}
                            ${documentInfo.creator ? ` | Ersteller: ${documentInfo.creator}` : ''}
                        </p>
                    </div>
                    <button onclick="downloadGeneratedDocx(${documentInfo.id || 'null'})" class="btn-success" style="width: auto; padding: 8px 16px; margin: 0;">üì• Download DOCX</button>
                </div>
                
                <div style="border: 1px solid #dee2e6; border-radius: 6px; padding: 20px; background: white; overflow-y: auto; max-height: calc(90vh - 200px);">
                    <div style="font-family: 'Times New Roman', serif; line-height: 1.6; color: #333;">
                        ${htmlContent}
                    </div>
                </div>
                
                <div style="margin-top: 15px; text-align: right;">
                    <button onclick="closeDocxPreviewModal()" class="btn-secondary" style="width: auto; padding: 10px 20px;">Schlie√üen</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(previewModal);
    
    // Modal au√üerhalb schlie√üen
    previewModal.addEventListener('click', function(e) {
        if (e.target === previewModal) {
            closeDocxPreviewModal();
        }
    });
}

// Modal schlie√üen
function closeDocxPreviewModal() {
    const modal = document.getElementById('docxPreviewModal');
    if (modal) {
        modal.remove();
    }
}

        function editDocument(docId) {
            alert('‚úèÔ∏è Dokument-Bearbeitung wird implementiert...');
        }

        async function deleteDocument(docId) {
            if (!confirm('Dokument wirklich l√∂schen?')) return;
            
            try {
                await apiCall(`/documents/${docId}`, {
                    method: 'DELETE'
                });
                
                alert('üóëÔ∏è Dokument erfolgreich gel√∂scht!');
                loadUserDocuments();
                
            } catch (error) {
                alert(`‚ùå Fehler beim L√∂schen: ${error.message}`);
            }
        }

        // G-Docs Template Functions
        let questionCounter = 0;

        function addQuestion() {
            questionCounter++;
            const questionsContainer = document.getElementById('questionsList');
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item';
            questionDiv.id = `question-${questionCounter}`;
            
            questionDiv.innerHTML = `
                <div class="question-header">
                    <span class="question-number">Frage ${questionCounter}</span>
                    <button type="button" class="question-remove" onclick="removeQuestion(${questionCounter})">üóëÔ∏è Entfernen</button>
                </div>
                <div class="question-fields">
                    <div class="form-group">
                        <label>Frage-Text:</label>
                        <input type="text" id="question-text-${questionCounter}" placeholder="z.B. Vollst√§ndiger Name" data-question-id="${questionCounter}">
                    </div>
                    <div class="form-group">
                        <label>Feld-Typ:</label>
                        <select id="question-type-${questionCounter}" data-question-id="${questionCounter}">
                            <option value="text">Text (Einzeilig)</option>
                            <option value="textarea">Text (Mehrzeilig)</option>
                            <option value="tel">Telefon</option>
                            <option value="date">Datum</option>
                            <option value="number">Zahl</option>
                            <option value="select">Auswahl (Dropdown)</option>
                            <option value="radio">Auswahl (Radio)</option>
                            <option value="checkbox">Checkboxen</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Platzhalter/Hilfstext:</label>
                        <input type="text" id="question-placeholder-${questionCounter}" placeholder="z.B. Vor- und Nachname" data-question-id="${questionCounter}">
                    </div>
                    <div class="form-group">
                        <label>Erforderlich:</label>
                        <label style="margin-top: 8px;"><input type="checkbox" id="question-required-${questionCounter}" data-question-id="${questionCounter}" checked> Pflichtfeld</label>
                    </div>
                    <div class="form-group full" id="question-options-${questionCounter}" style="display: none;">
                        <label>Auswahloptionen (eine pro Zeile):</label>
                        <textarea id="question-options-text-${questionCounter}" placeholder="Option 1&#10;Option 2&#10;Option 3" rows="3" data-question-id="${questionCounter}"></textarea>
                    </div>
                </div>
            `;
            
            questionsContainer.appendChild(questionDiv);
            
            // Event Listener f√ºr Typ-√Ñnderung
            const typeSelect = document.getElementById(`question-type-${questionCounter}`);
            typeSelect.addEventListener('change', function() {
                toggleOptionsField(questionCounter, this.value);
            });
            
            console.log('‚ûï Frage hinzugef√ºgt:', questionCounter);
        }

        function removeQuestion(questionId) {
            const questionDiv = document.getElementById(`question-${questionId}`);
            if (questionDiv) {
                questionDiv.remove();
                console.log('üóëÔ∏è Frage entfernt:', questionId);
            }
        }

        function toggleOptionsField(questionId, fieldType) {
            const optionsDiv = document.getElementById(`question-options-${questionId}`);
            if (optionsDiv) {
                const showOptions = ['select', 'radio', 'checkbox'].includes(fieldType);
                optionsDiv.style.display = showOptions ? 'block' : 'none';
            }
        }

        function collectQuestions() {
            const questions = [];
            const questionItems = document.querySelectorAll('.question-item');
            
            questionItems.forEach((item, index) => {
                const questionId = item.id.split('-')[1];
                const text = document.getElementById(`question-text-${questionId}`)?.value.trim();
                const type = document.getElementById(`question-type-${questionId}`)?.value;
                const placeholder = document.getElementById(`question-placeholder-${questionId}`)?.value.trim();
                const required = document.getElementById(`question-required-${questionId}`)?.checked;
                const optionsText = document.getElementById(`question-options-text-${questionId}`)?.value.trim();
                
                if (text) {
                    const question = {
                        id: questionId,
                        order: index + 1,
                        text: text,
                        type: type,
                        placeholder: placeholder || '',
                        required: required || false,
                        options: optionsText ? optionsText.split('\n').filter(opt => opt.trim()) : []
                    };
                    questions.push(question);
                }
            });
            
            console.log('üìã Gesammelte Fragen:', questions);
            return questions;
        }

        async function createGdocsTemplate() {
    const questions = collectQuestions();
    
    const fileInput = document.getElementById('templateFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showError('gdocsCreateError', 'Bitte w√§hlen Sie eine DOCX-Datei aus.');
        return;
    }
    
    if (!file.name.toLowerCase().endsWith('.docx')) {
        showError('gdocsCreateError', 'Nur DOCX-Dateien sind erlaubt.');
        return;
    }
    
    if (questions.length === 0) {
        showError('gdocsCreateError', 'Bitte f√ºgen Sie mindestens eine Frage hinzu.');
        return;
    }
    
    const formData = new FormData();
    formData.append('templateFile', file);
    formData.append('name', document.getElementById('templateName').value.trim());
    formData.append('description', document.getElementById('templateDescription').value.trim());
    formData.append('createdBy', currentSession.user.username);
    formData.append('questions', JSON.stringify(questions));

    // Verf√ºgbare R√§nge sammeln
    const rankCheckboxes = document.querySelectorAll('#gdocsTabContent input[type="checkbox"]:checked');
    const availableRanks = Array.from(rankCheckboxes).map(cb => cb.value);
    availableRanks.forEach(rank => {
        formData.append('availableRanks', rank);
    });

    console.log('üìÅ Template wird hochgeladen...');

    try {
        const response = await fetch(`${API_BASE}/create-gdocs-template`, {
            method: 'POST',
            body: formData // Kein JSON Content-Type bei FormData
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        showSuccess('gdocsCreateSuccess', `DOCX-Vorlage mit ${questions.length} Fragen erfolgreich hochgeladen! (ID: ${result.templateId})`);
        
        // Form zur√ºcksetzen
        document.getElementById('templateName').value = '';
        document.getElementById('templateFile').value = '';
        document.getElementById('templateDescription').value = '';
        document.getElementById('questionsList').innerHTML = '';
        questionCounter = 0;
        
        loadGdocsTemplates();

    } catch (error) {
        showError('gdocsCreateError', error.message);
        console.error('‚ùå Template-Upload Fehler:', error);
    }
}

        async function loadGdocsTemplates() {
    console.log('üìù loadGdocsTemplates() gestartet');
    
    const container = document.getElementById('gdocsTemplatesList');
    if (!container) {
        console.error('‚ùå gdocsTemplatesList Container nicht gefunden!');
        return;
    }
    
    console.log('üì¶ G-Docs Container gefunden:', container);
    container.innerHTML = '<div class="loading">Lade G-Docs Vorlagen...</div>';
    
    try {
        console.log('üîó API-Aufruf: /gdocs-templates');
        const templates = await apiCall('/gdocs-templates');
        console.log('üìù G-Docs Templates erhalten:', templates);
        console.log('üîÑ Rufe updateGdocsTemplatesList auf...');
        
        // DEBUG: Pr√ºfe ob updateGdocsTemplatesList existiert
        if (typeof updateGdocsTemplatesList === 'function') {
            updateGdocsTemplatesList(templates);
            console.log('‚úÖ updateGdocsTemplatesList aufgerufen');
        } else {
            console.error('‚ùå updateGdocsTemplatesList Funktion nicht gefunden!');
            // FALLBACK: Direkt setzen
            if (templates.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Noch keine G-Docs Vorlagen erstellt</p>';
            }
        }
    } catch (error) {
        console.error('‚ùå Fehler beim Laden der G-Docs Templates:', error);
        container.innerHTML = `<p style="color: red;">Fehler beim Laden: ${error.message}</p>`;
    }
}
        function updateGdocsTemplatesList(templates) {
            const container = document.getElementById('gdocsTemplatesList');
            if (!container) return;
            
            if (templates.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Noch keine G-Docs Vorlagen erstellt</p>';
                return;
            }

            container.innerHTML = templates.map(template => {
                let questionsInfo = '';
                if (template.questions) {
                    try {
                        const questions = typeof template.questions === 'string' ? JSON.parse(template.questions) : template.questions;
                        questionsInfo = `<p><strong>Fragen:</strong> ${questions.length} definiert</p>
                                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                            ${questions.map(q => `‚Ä¢ ${q.text} (${q.type})`).join('<br>')}
                                        </div>`;
                    } catch (e) {
                        questionsInfo = '<p><strong>Fragen:</strong> Keine definiert</p>';
                    }
                } else {
                    questionsInfo = '<p><strong>Fragen:</strong> Keine definiert</p>';
                }
                
                return `
                <div class="document-item">
                    <div class="document-date">Erstellt: ${new Date(template.created_at).toLocaleString('de-DE')}</div>
                    <div class="document-title">üìù ${template.name}</div>
                    <div class="document-details">
                        <p><strong>Beschreibung:</strong> ${template.description}</p>
                        <p><strong>DOCX-Datei:</strong> ${template.original_filename || 'Unbekannt'}</p>
                        <p><strong>Verf√ºgbar f√ºr:</strong> ${template.available_ranks}</p>
                        ${questionsInfo}
                        <p><strong>Erstellt von:</strong> ${template.created_by}</p>
                    </div>
                    <div class="document-actions">
                        <button class="btn-secondary" onclick="downloadTemplate(${template.id})">üìÑ DOCX herunterladen</button>
                        <button class="btn-success" onclick="previewQuestions(${template.id})">üëÅÔ∏è Fragen ansehen</button>
                        <button class="btn-warning" onclick="editGdocsTemplate(${template.id})">‚úèÔ∏è Bearbeiten</button>
                        <button class="btn-danger" onclick="deleteGdocsTemplate(${template.id})">üóëÔ∏è L√∂schen</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function downloadTemplate(templateId) {
    console.log('üìÑ Lade DOCX-Vorlage herunter, ID:', templateId);
    
    const downloadUrl = `${API_BASE}/download-template/${templateId}`;
    
    // Erstelle tempor√§ren Download-Link
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

        async function loadAvailableTemplates() {
    console.log('üìã loadAvailableTemplates() gestartet');
    
    const container = document.getElementById('availableTemplatesList');
    if (!container) {
        console.error('‚ùå availableTemplatesList Container nicht gefunden!');
        return;
    }
    
    console.log('üì¶ Container gefunden:', container);
    container.innerHTML = '<div class="loading">Lade verf√ºgbare Vorlagen...</div>';
    
    if (!currentSession.user) {
        console.error('‚ùå Kein Benutzer angemeldet!');
        container.innerHTML = '<p style="color: red;">Fehler: Kein Benutzer angemeldet</p>';
        return;
    }
    
    const userRank = currentSession.user.rank || 'user';
    console.log('üë§ Benutzer-Rang f√ºr Templates:', userRank);
    
    try {
        console.log('üîó API-Aufruf:', `/available-templates/${userRank}`);
        const templates = await apiCall(`/available-templates/${userRank}`);
        console.log('üìã Templates erhalten:', templates);
        console.log('üîÑ Rufe updateAvailableTemplatesList auf...');
        
        // DEBUG: Pr√ºfe ob updateAvailableTemplatesList existiert
        if (typeof updateAvailableTemplatesList === 'function') {
            updateAvailableTemplatesList(templates);
            console.log('‚úÖ updateAvailableTemplatesList aufgerufen');
        } else {
            console.error('‚ùå updateAvailableTemplatesList Funktion nicht gefunden!');
            // FALLBACK: Direkt setzen
            if (templates.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Keine Vorlagen f√ºr Ihren Rang verf√ºgbar</p>';
            }
        }
    } catch (error) {
        console.error('‚ùå Fehler beim Laden der Templates:', error);
        container.innerHTML = `<p style="color: red;">Fehler beim Laden: ${error.message}</p>`;
    }
}

        function updateAvailableTemplatesList(templates) {
            const container = document.getElementById('availableTemplatesList');
            if (!container) return;
            
            if (templates.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Keine Vorlagen f√ºr Ihren Rang verf√ºgbar</p>';
                return;
            }

            container.innerHTML = templates.map(template => {
                let questionsPreview = '';
                if (template.questions) {
                    try {
                        const questions = typeof template.questions === 'string' ? JSON.parse(template.questions) : template.questions;
                        questionsPreview = `<p><strong>Zu beantwortende Fragen:</strong> ${questions.length}</p>
                                          <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                              ${questions.slice(0, 3).map(q => `‚Ä¢ ${q.text}`).join('<br>')}
                                              ${questions.length > 3 ? '<br>‚Ä¢ ...' : ''}
                                          </div>`;
                    } catch (e) {
                        questionsPreview = '<p><strong>Fragen:</strong> Keine definiert</p>';
                    }
                } else {
                    questionsPreview = '<p><strong>Fragen:</strong> Keine definiert</p>';
                }
                
                return `
                <div class="document-item">
                    <div class="document-title">üìã ${template.name}</div>
                    <div class="document-details">
                        <p><strong>Beschreibung:</strong> ${template.description}</p>
                        ${questionsPreview}
                        <p><strong>Erstellt von:</strong> ${template.created_by}</p>
                    </div>
                    <div class="document-actions">
                        <button class="btn-success" onclick="fillTemplate(${template.id})">üìù Fragebogen ausf√ºllen</button>
                        <button class="btn-secondary" onclick="downloadTemplate(${template.id})">üìÑ DOCX herunterladen</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function fillTemplate(templateId) {
            console.log('üìù Fragebogen ausf√ºllen f√ºr Template ID:', templateId);
            
            // Template-Daten laden
            loadTemplateForFilling(templateId);
        }

        async function loadTemplateForFilling(templateId) {
            try {
                console.log('üîó Lade Template-Details f√ºr ID:', templateId);
                const template = await apiCall(`/gdocs-template/${templateId}`);
                console.log('üìã Template-Details erhalten:', template);
                
                if (!template.questions) {
                    alert('‚ùå Diese Vorlage hat keine Fragen definiert.');
                    return;
                }
                
                const questions = typeof template.questions === 'string' ? JSON.parse(template.questions) : template.questions;
                showTemplateForm(template, questions);
                
            } catch (error) {
                console.error('‚ùå Fehler beim Laden des Templates:', error);
                alert(`Fehler beim Laden: ${error.message}`);
            }
        }

        function showTemplateForm(template, questions) {
            // Erstelle ein Modal f√ºr das Fragebogen-Formular
            const formModal = document.createElement('div');
            formModal.className = 'documents-modal active';
            formModal.id = 'templateFormModal';
            
            formModal.innerHTML = `
                <div class="documents-modal-content">
                    <div class="documents-modal-header">
                        <h2 class="documents-modal-title">üìù ${template.name} ausf√ºllen</h2>
                        <button class="documents-modal-close" onclick="closeTemplateForm()">√ó</button>
                    </div>
                    <div class="documents-modal-body">
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <p><strong>Beschreibung:</strong> ${template.description}</p>
                            <p><strong>Google Docs:</strong> <a href="${template.gdocs_url}" target="_blank">üìÑ Vorlage ansehen</a></p>
                        </div>
                        
                        <form id="templateForm" data-template-id="${template.id}">
                            ${generateFormFields(questions)}
                        </form>
                        
                        <div style="margin-top: 20px; text-align: right;">
                            <button onclick="closeTemplateForm()" class="btn-secondary" style="width: auto; padding: 10px 20px; margin-right: 10px;">Abbrechen</button>
                            <button onclick="submitTemplateForm()" class="btn-success" style="width: auto; padding: 10px 20px;">üìù Absenden</button>
                        </div>
                        
                        <div id="templateFormError" class="error"></div>
                        <div id="templateFormSuccess" class="success"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(formModal);
        }

        function generateFormFields(questions) {
            return questions.map(question => {
                let fieldHtml = '';
                const required = question.required ? 'required' : '';
                const placeholder = question.placeholder ? `placeholder="${question.placeholder}"` : '';
                
                switch (question.type) {
                    case 'textarea':
                        fieldHtml = `<textarea id="field-${question.id}" ${placeholder} ${required} rows="3"></textarea>`;
                        break;
                    case 'select':
                        const selectOptions = question.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                        fieldHtml = `<select id="field-${question.id}" ${required}>
                                       <option value="">-- Bitte w√§hlen --</option>
                                       ${selectOptions}
                                     </select>`;
                        break;
                    case 'radio':
                        const radioOptions = question.options.map((opt, index) => 
                            `<label style="display: block; margin: 5px 0;">
                               <input type="radio" name="field-${question.id}" value="${opt}" ${required}> ${opt}
                             </label>`
                        ).join('');
                        fieldHtml = `<div>${radioOptions}</div>`;
                        break;
                    case 'checkbox':
                        const checkboxOptions = question.options.map((opt, index) => 
                            `<label style="display: block; margin: 5px 0;">
                               <input type="checkbox" name="field-${question.id}[]" value="${opt}"> ${opt}
                             </label>`
                        ).join('');
                        fieldHtml = `<div>${checkboxOptions}</div>`;
                        break;
                    default:
                        fieldHtml = `<input type="${question.type}" id="field-${question.id}" ${placeholder} ${required}>`;
                }
                
                return `
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            ${question.text}${question.required ? ' *' : ''}
                        </label>
                        ${fieldHtml}
                    </div>
                `;
            }).join('');
        }

        function closeTemplateForm() {
            const modal = document.getElementById('templateFormModal');
            if (modal) {
                modal.remove();
            }
        }

        async function submitTemplateForm() {
            const form = document.getElementById('templateForm');
            const templateId = form.dataset.templateId;
            
            // Sammle alle Antworten
            const answers = {};
            const formData = new FormData(form);
            
            // Normale Felder
            for (let [key, value] of formData.entries()) {
                if (key.includes('[]')) {
                    // Checkbox arrays
                    const cleanKey = key.replace('[]', '');
                    if (!answers[cleanKey]) answers[cleanKey] = [];
                    answers[cleanKey].push(value);
                } else {
                    answers[key] = value;
                }
            }
            
            // Zus√§tzliche Felder (die nicht in FormData sind)
            const allInputs = form.querySelectorAll('input, textarea, select');
            allInputs.forEach(input => {
                if (input.type === 'radio' && input.checked) {
                    answers[input.name] = input.value;
                } else if (input.type !== 'radio' && input.type !== 'checkbox' && input.id.startsWith('field-')) {
                    answers[input.id] = input.value;
                }
            });
            
            console.log('üìã Gesammelte Antworten:', answers);
            
            try {
                const result = await apiCall('/submit-template-response', {
                    method: 'POST',
                    body: JSON.stringify({
                        templateId: templateId,
                        answers: answers,
                        submittedBy: currentSession.user.username
                    })
                });
                
                showSuccess('templateFormSuccess', '‚úÖ Fragebogen erfolgreich abgesendet! Die Antworten werden in das Google Doc eingef√ºgt.');
                
                setTimeout(() => {
                    closeTemplateForm();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Fehler beim Absenden:', error);
                showError('templateFormError', error.message);
            }
        }

        function previewQuestions(templateId) {
            // Lade Template und zeige Fragen-Vorschau
            loadTemplateForPreview(templateId);
        }

        async function loadTemplateForPreview(templateId) {
            try {
                const template = await apiCall(`/gdocs-template/${templateId}`);
                
                if (!template.questions) {
                    alert('‚ùå Diese Vorlage hat keine Fragen definiert.');
                    return;
                }
                
                const questions = typeof template.questions === 'string' ? JSON.parse(template.questions) : template.questions;
                showQuestionsPreview(template, questions);
                
            } catch (error) {
                console.error('‚ùå Fehler beim Laden:', error);
                alert(`Fehler: ${error.message}`);
            }
        }

        function showQuestionsPreview(template, questions) {
            const previewModal = document.createElement('div');
            previewModal.className = 'documents-modal active';
            previewModal.id = 'questionsPreviewModal';
            
            previewModal.innerHTML = `
                <div class="documents-modal-content">
                    <div class="documents-modal-header">
                        <h2 class="documents-modal-title">üëÅÔ∏è Fragen-Vorschau: ${template.name}</h2>
                        <button class="documents-modal-close" onclick="closeQuestionsPreview()">√ó</button>
                    </div>
                    <div class="documents-modal-body">
                        <div style="margin-bottom: 20px;">
                            <p><strong>Vorlage:</strong> ${template.name}</p>
                            <p><strong>Beschreibung:</strong> ${template.description}</p>
                            <p><strong>Anzahl Fragen:</strong> ${questions.length}</p>
                        </div>
                        
                        <h3>üìã Definierte Fragen:</h3>
                        ${questions.map((q, index) => `
                            <div class="question-item" style="margin: 15px 0;">
                                <div class="question-header">
                                    <span class="question-number">Frage ${index + 1}</span>
                                    <span style="font-size: 12px; color: #666;">${q.required ? 'Pflichtfeld' : 'Optional'}</span>
                                </div>
                                <p><strong>${q.text}</strong></p>
                                <p style="font-size: 13px; color: #666;">
                                    Typ: ${q.type} 
                                    ${q.placeholder ? `| Platzhalter: "${q.placeholder}"` : ''}
                                    ${q.options && q.options.length > 0 ? `| Optionen: ${q.options.join(', ')}` : ''}
                                </p>
                            </div>
                        `).join('')}
                        
                        <div style="margin-top: 20px; text-align: right;">
                            <button onclick="closeQuestionsPreview()" class="btn-secondary" style="width: auto; padding: 10px 20px;">Schlie√üen</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(previewModal);
        }

        function closeQuestionsPreview() {
            const modal = document.getElementById('questionsPreviewModal');
            if (modal) {
                modal.remove();
            }
        }

        async function editGdocsTemplate(templateId) {
    console.log('‚úèÔ∏è Bearbeite Template ID:', templateId);
    
    try {
        // Lade Template-Details
        const template = await apiCall(`/gdocs-template/${templateId}`);
        
        showEditTemplateModal(template);
        
    } catch (error) {
        console.error('‚ùå Fehler beim Laden des Templates:', error);
        alert(`Fehler: ${error.message}`);
    }
}

function showEditTemplateModal(template) {
    // Entferne bereits vorhandenes Modal
    const existingModal = document.getElementById('editTemplateModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const editModal = document.createElement('div');
    editModal.className = 'documents-modal active';
    editModal.id = 'editTemplateModal';
    
    editModal.innerHTML = `
        <div class="documents-modal-content">
            <div class="documents-modal-header">
                <h2 class="documents-modal-title">‚úèÔ∏è Template bearbeiten: ${template.name}</h2>
                <button class="documents-modal-close" onclick="closeEditTemplateModal()">√ó</button>
            </div>
            <div class="documents-modal-body">
                <form id="editTemplateForm">
                    <div class="form-group">
                        <label>Template-Name:</label>
                        <input type="text" id="editTemplateName" value="${template.name}" required>
                    </div>
                    <div class="form-group">
                        <label>Beschreibung:</label>
                        <textarea id="editTemplateDescription" rows="3">${template.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Neue DOCX-Datei hochladen (optional):</label>
                        <input type="file" id="editTemplateFile" accept=".docx">
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Aktuelle Datei: ${template.original_filename}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Verf√ºgbar f√ºr R√§nge:</label>
                        <div class="gdocs-rank-selector">
                            <label><input type="checkbox" value="besucher" ${template.available_ranks.includes('besucher') ? 'checked' : ''}> Besucher</label>
                            <label><input type="checkbox" value="user" ${template.available_ranks.includes('user') ? 'checked' : ''}> User</label>
                            <label><input type="checkbox" value="socom-operator" ${template.available_ranks.includes('socom-operator') ? 'checked' : ''}> SOCOM</label>
                            <label><input type="checkbox" value="kabinettsmitglied" ${template.available_ranks.includes('kabinettsmitglied') ? 'checked' : ''}> Kabinett</label>
                            <label><input type="checkbox" value="admin" ${template.available_ranks.includes('admin') ? 'checked' : ''}> Admin+</label>
                        </div>
                    </div>
                </form>
                
                <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
    <button onclick="editTemplateQuestions(${template.id})" class="btn-warning" style="width: auto; padding: 10px 20px;">üìù Fragen bearbeiten</button>
    <div>
        <button onclick="closeEditTemplateModal()" class="btn-secondary" style="width: auto; padding: 10px 20px; margin-right: 10px;">Abbrechen</button>
        <button onclick="saveTemplateChanges(${template.id})" class="btn-success" style="width: auto; padding: 10px 20px;">üíæ Speichern</button>
    </div>
</div>
                
                <div id="editTemplateError" class="error"></div>
                <div id="editTemplateSuccess" class="success"></div>
            </div>
        </div>
    `;
    
    document.body.appendChild(editModal);
}

function closeEditTemplateModal() {
    const modal = document.getElementById('editTemplateModal');
    if (modal) {
        modal.remove();
    }
}
async function editTemplateQuestions(templateId) {
    console.log('üìù Bearbeite Fragen f√ºr Template ID:', templateId);
    
    try {
        // Lade Template-Details
        const template = await apiCall(`/gdocs-template/${templateId}`);
        
        showTemplateQuestionsEditModal(template);
        
    } catch (error) {
        console.error('‚ùå Fehler beim Laden des Templates:', error);
        alert(`Fehler: ${error.message}`);
    }
}

function showTemplateQuestionsEditModal(template) {
    // Entferne bereits vorhandenes Modal
    const existingModal = document.getElementById('editQuestionsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const questionsModal = document.createElement('div');
    questionsModal.className = 'documents-modal active';
    questionsModal.id = 'editQuestionsModal';
    
    questionsModal.innerHTML = `
        <div class="documents-modal-content" style="max-width: 1000px;">
            <div class="documents-modal-header">
                <h2 class="documents-modal-title">üìù Fragen bearbeiten: ${template.name}</h2>
                <button class="documents-modal-close" onclick="closeEditQuestionsModal()">√ó</button>
            </div>
            <div class="documents-modal-body">
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <p><strong>Template:</strong> ${template.name}</p>
                    <p><strong>Beschreibung:</strong> ${template.description || 'Keine Beschreibung'}</p>
                </div>
                
                <h3>üìã Fragen bearbeiten:</h3>
                <div id="editQuestionsList" class="questions-container">
                    <!-- Fragen werden hier geladen -->
                </div>
                <button type="button" onclick="addEditQuestion()" class="btn-secondary" style="width: auto; padding: 8px 16px; margin: 10px 0;">‚ûï Neue Frage hinzuf√ºgen</button>
                
                <div style="margin-top: 30px; text-align: right;">
                    <button onclick="closeEditQuestionsModal()" class="btn-secondary" style="width: auto; padding: 10px 20px; margin-right: 10px;">Abbrechen</button>
                    <button onclick="saveTemplateQuestions(${template.id})" class="btn-success" style="width: auto; padding: 10px 20px;">üíæ Fragen speichern</button>
                </div>
                
                <div id="editQuestionsError" class="error"></div>
                <div id="editQuestionsSuccess" class="success"></div>
            </div>
        </div>
    `;
    
    document.body.appendChild(questionsModal);
    
    // Lade bestehende Fragen
    loadExistingQuestions(template);
    
    // Modal au√üerhalb schlie√üen
    questionsModal.addEventListener('click', function(e) {
        if (e.target === questionsModal) {
            closeEditQuestionsModal();
        }
    });
}

function loadExistingQuestions(template) {
    const container = document.getElementById('editQuestionsList');
    if (!container) return;
    
    // Reset counter
    editQuestionCounter = 0;
    
    if (template.questions) {
        try {
            const questions = typeof template.questions === 'string' ? JSON.parse(template.questions) : template.questions;
            
            if (Array.isArray(questions) && questions.length > 0) {
                questions.forEach(question => {
                    addEditQuestion(question);
                });
                console.log(`‚úÖ ${questions.length} bestehende Fragen geladen`);
            } else {
                console.log('‚ÑπÔ∏è Keine bestehenden Fragen gefunden');
            }
        } catch (e) {
            console.error('‚ùå Fehler beim Parsen der Fragen:', e);
        }
    }
    
    // Falls keine Fragen geladen wurden, f√ºge eine leere hinzu
    if (editQuestionCounter === 0) {
        addEditQuestion();
    }
}

let editQuestionCounter = 0;

function addEditQuestion(existingQuestion = null) {
    editQuestionCounter++;
    const questionsContainer = document.getElementById('editQuestionsList');
    
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question-item';
    questionDiv.id = `edit-question-${editQuestionCounter}`;
    
    const questionData = existingQuestion || {
        text: '',
        type: 'text',
        placeholder: '',
        required: true,
        options: []
    };
    
    questionDiv.innerHTML = `
        <div class="question-header">
            <span class="question-number">Frage ${editQuestionCounter}</span>
            <button type="button" class="question-remove" onclick="removeEditQuestion(${editQuestionCounter})">üóëÔ∏è Entfernen</button>
        </div>
        <div class="question-fields">
            <div class="form-group">
                <label>Frage-Text:</label>
                <input type="text" id="edit-question-text-${editQuestionCounter}" placeholder="z.B. Vollst√§ndiger Name" value="${questionData.text}" data-question-id="${editQuestionCounter}">
            </div>
            <div class="form-group">
                <label>Feld-Typ:</label>
                <select id="edit-question-type-${editQuestionCounter}" data-question-id="${editQuestionCounter}">
                    <option value="text" ${questionData.type === 'text' ? 'selected' : ''}>Text (Einzeilig)</option>
                    <option value="textarea" ${questionData.type === 'textarea' ? 'selected' : ''}>Text (Mehrzeilig)</option>
                    <option value="tel" ${questionData.type === 'tel' ? 'selected' : ''}>Telefon</option>
                    <option value="date" ${questionData.type === 'date' ? 'selected' : ''}>Datum</option>
                    <option value="number" ${questionData.type === 'number' ? 'selected' : ''}>Zahl</option>
                    <option value="select" ${questionData.type === 'select' ? 'selected' : ''}>Auswahl (Dropdown)</option>
                    <option value="radio" ${questionData.type === 'radio' ? 'selected' : ''}>Auswahl (Radio)</option>
                    <option value="checkbox" ${questionData.type === 'checkbox' ? 'selected' : ''}>Checkboxen</option>
                </select>
            </div>
            <div class="form-group">
                <label>Platzhalter/Hilfstext:</label>
                <input type="text" id="edit-question-placeholder-${editQuestionCounter}" placeholder="z.B. Vor- und Nachname" value="${questionData.placeholder}" data-question-id="${editQuestionCounter}">
            </div>
            <div class="form-group">
                <label>Erforderlich:</label>
                <label style="margin-top: 8px;"><input type="checkbox" id="edit-question-required-${editQuestionCounter}" data-question-id="${editQuestionCounter}" ${questionData.required ? 'checked' : ''}> Pflichtfeld</label>
            </div>
            <div class="form-group full" id="edit-question-options-${editQuestionCounter}" style="display: ${['select', 'radio', 'checkbox'].includes(questionData.type) ? 'block' : 'none'};">
                <label>Auswahloptionen (eine pro Zeile):</label>
                <textarea id="edit-question-options-text-${editQuestionCounter}" placeholder="Option 1&#10;Option 2&#10;Option 3" rows="3" data-question-id="${editQuestionCounter}">${Array.isArray(questionData.options) ? questionData.options.join('\n') : ''}</textarea>
            </div>
        </div>
    `;
    
    questionsContainer.appendChild(questionDiv);
    
    // Event Listener f√ºr Typ-√Ñnderung
    const typeSelect = document.getElementById(`edit-question-type-${editQuestionCounter}`);
    typeSelect.addEventListener('change', function() {
        toggleEditOptionsField(editQuestionCounter, this.value);
    });
    
    console.log('‚ûï Bearbeitungs-Frage hinzugef√ºgt:', editQuestionCounter);
}

function removeEditQuestion(questionId) {
    const questionDiv = document.getElementById(`edit-question-${questionId}`);
    if (questionDiv) {
        questionDiv.remove();
        console.log('üóëÔ∏è Bearbeitungs-Frage entfernt:', questionId);
    }
}

function toggleEditOptionsField(questionId, fieldType) {
    const optionsDiv = document.getElementById(`edit-question-options-${questionId}`);
    if (optionsDiv) {
        const showOptions = ['select', 'radio', 'checkbox'].includes(fieldType);
        optionsDiv.style.display = showOptions ? 'block' : 'none';
    }
}

function collectEditQuestions() {
    const questions = [];
    const questionItems = document.querySelectorAll('#editQuestionsList .question-item');
    
    questionItems.forEach((item, index) => {
        const questionId = item.id.split('-')[2]; // edit-question-X
        const text = document.getElementById(`edit-question-text-${questionId}`)?.value.trim();
        const type = document.getElementById(`edit-question-type-${questionId}`)?.value;
        const placeholder = document.getElementById(`edit-question-placeholder-${questionId}`)?.value.trim();
        const required = document.getElementById(`edit-question-required-${questionId}`)?.checked;
        const optionsText = document.getElementById(`edit-question-options-text-${questionId}`)?.value.trim();
        
        if (text) {
            const question = {
                id: questionId,
                order: index + 1,
                text: text,
                type: type,
                placeholder: placeholder || '',
                required: required || false,
                options: optionsText ? optionsText.split('\n').filter(opt => opt.trim()) : []
            };
            questions.push(question);
        }
    });
    
    console.log('üìã Gesammelte bearbeitete Fragen:', questions);
    return questions;
}

async function saveTemplateQuestions(templateId) {
    const questions = collectEditQuestions();
    
    if (questions.length === 0) {
        showError('editQuestionsError', 'Mindestens eine Frage muss vorhanden sein');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/update-template-questions/${templateId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ questions: questions })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        showSuccess('editQuestionsSuccess', `Fragen erfolgreich aktualisiert! (${questions.length} Fragen gespeichert)`);
        
        setTimeout(() => {
            closeEditQuestionsModal();
            loadGdocsTemplates(); // Aktualisiere die Template-Liste
        }, 1500);
        
    } catch (error) {
        showError('editQuestionsError', error.message);
    }
}

function closeEditQuestionsModal() {
    const modal = document.getElementById('editQuestionsModal');
    if (modal) {
        modal.remove();
    }
}
async function saveTemplateChanges(templateId) {
    const name = document.getElementById('editTemplateName').value.trim();
    const description = document.getElementById('editTemplateDescription').value.trim();
    const fileInput = document.getElementById('editTemplateFile');
    
    if (!name) {
        showError('editTemplateError', 'Name ist erforderlich');
        return;
    }
    
    // Sammle ausgew√§hlte R√§nge
    const rankCheckboxes = document.querySelectorAll('#editTemplateModal input[type="checkbox"]:checked');
    const availableRanks = Array.from(rankCheckboxes).map(cb => cb.value);
    
    if (availableRanks.length === 0) {
        showError('editTemplateError', 'Mindestens ein Rang muss ausgew√§hlt werden');
        return;
    }
    
    const formData = new FormData();
    formData.append('name', name);
    formData.append('description', description);
    formData.append('availableRanks', availableRanks.join(','));
    
    if (fileInput.files[0]) {
        formData.append('templateFile', fileInput.files[0]);
    }
    
    try {
        const response = await fetch(`${API_BASE}/update-gdocs-template/${templateId}`, {
            method: 'PUT',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        showSuccess('editTemplateSuccess', 'Template erfolgreich aktualisiert!');
        
        setTimeout(() => {
            closeEditTemplateModal();
            loadGdocsTemplates(); // Aktualisiere die Liste
        }, 1500);
        
    } catch (error) {
        showError('editTemplateError', error.message);
    }
}

        async function deleteGdocsTemplate(templateId) {
            if (!confirm('G-Docs Vorlage wirklich l√∂schen?')) return;
            
            try {
                await apiCall(`/gdocs-templates/${templateId}`, {
                    method: 'DELETE'
                });
                
                alert('üóëÔ∏è G-Docs Vorlage erfolgreich gel√∂scht!');
                loadGdocsTemplates();
                
            } catch (error) {
                alert(`‚ùå Fehler beim L√∂schen: ${error.message}`);
            }
        }

        // Modal au√üerhalb schlie√üen
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('documentsModal');
            const modalContent = document.querySelector('.documents-modal-content');
            
            if (modal && modal.classList.contains('active') && !modalContent.contains(event.target)) {
                closeDocumentsModal();
            }
            
            // Dropdown schlie√üen
            const dropdown = document.getElementById('userDropdownMenu');
            const toggle = document.querySelector('.dropdown-toggle');
            const userDropdown = document.querySelector('.user-dropdown');
            
            if (dropdown && toggle && userDropdown && !userDropdown.contains(event.target)) {
                dropdown.classList.remove('active');
                toggle.classList.remove('active');
            }
        });

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üèõÔ∏è Regierungspanel geladen');
            console.log('üåô Dark Mode wird √ºber SQL-Datenbank verwaltet');
            
            // Pr√ºfe ob der Dokumente-Button existiert
            const documentsBtn = document.getElementById('navDocumentsBtn');
            console.log('üìÑ Dokumente-Button gefunden:', documentsBtn ? 'JA' : 'NEIN');
            
            if (documentsBtn) {
                console.log('üìÑ Button sichtbar:', documentsBtn.style.display !== 'none');
                console.log('üìÑ Button onclick:', documentsBtn.onclick ? 'Vorhanden' : 'Fehlt');
                
                // Backup Event Listener hinzuf√ºgen
                documentsBtn.addEventListener('click', function(e) {
                    console.log('üìÑ Dokumente-Button CLICK EVENT ausgel√∂st!');
                    e.preventDefault();
                    e.stopPropagation();
                    openDocumentsModal();
                });
            }
            
            // Test-Funktionen f√ºr Debugging √ºber Konsole verf√ºgbar machen
            window.testDocumentsModal = function() {
                console.log('üß™ Test-Funktion f√ºr Dokumente-Modal');
                openDocumentsModal();
            };
            
            window.checkDocumentsButton = function() {
                const btn = document.getElementById('navDocumentsBtn');
                console.log('üîç Button Check:');
                console.log('- Existiert:', btn ? 'JA' : 'NEIN');
                console.log('- Sichtbar:', btn ? btn.style.display : 'N/A');
                console.log('- onclick:', btn ? (btn.onclick ? 'JA' : 'NEIN') : 'N/A');
                return btn;
            };
            
            window.checkModal = function() {
                const modal = document.getElementById('documentsModal');
                console.log('üîç Modal Check:');
                console.log('- Existiert:', modal ? 'JA' : 'NEIN');
                console.log('- CSS Display:', modal ? getComputedStyle(modal).display : 'N/A');
                console.log('- CSS Visibility:', modal ? getComputedStyle(modal).visibility : 'N/A');
                console.log('- CSS Z-Index:', modal ? getComputedStyle(modal).zIndex : 'N/A');
                console.log('- Active Class:', modal ? modal.classList.contains('active') : 'N/A');
                return modal;
            };
            
            window.forceShowModal = function() {
                const modal = document.getElementById('documentsModal');
                if (modal) {
                    modal.style.display = 'flex !important';
                    modal.style.visibility = 'visible !important';
                    modal.style.opacity = '1 !important';
                    modal.style.zIndex = '99999 !important';
                    modal.classList.add('active');
                    console.log('üîß Modal mit Force-Styles angezeigt');
                } else {
                    console.error('‚ùå Modal nicht gefunden');
                }
            };
            
            // Mache openDocumentsModal global verf√ºgbar
            window.openDocumentsModal = openDocumentsModal;
            
            window.debugGDocsTab = function() {
                console.log('üîç G-Docs Tab Debug:');
                
                // Pr√ºfe ob Modal sichtbar ist
                const modal = document.getElementById('documentsModal');
                console.log('- Modal existiert:', modal ? 'JA' : 'NEIN');
                console.log('- Modal aktiv:', modal ? modal.classList.contains('active') : 'N/A');
                
                // Pr√ºfe G-Docs Tab Button
                const gdocsButton = document.getElementById('gdocsTabButton');
                console.log('- G-Docs Button existiert:', gdocsButton ? 'JA' : 'NEIN');
                console.log('- G-Docs Button sichtbar:', gdocsButton ? gdocsButton.style.display : 'N/A');
                
                // Pr√ºfe G-Docs Tab Content
                const gdocsContent = document.getElementById('gdocsTabContent');
                console.log('- G-Docs Content existiert:', gdocsContent ? 'JA' : 'NEIN');
                console.log('- G-Docs Content sichtbar:', gdocsContent ? gdocsContent.style.display : 'N/A');
                
                // Pr√ºfe Benutzer-Rechte
                console.log('- Aktueller Benutzer:', currentSession.user ? currentSession.user.username : 'KEIN BENUTZER');
                console.log('- Benutzer-Rang:', currentSession.user ? currentSession.user.rank : 'N/A');
                
                if (currentSession.user) {
                    const hasAdminRights = hasFullAccess(currentSession.user.rank || 'user');
                    console.log('- Admin-Rechte:', hasAdminRights);
                }
                
                // Pr√ºfe Fragen-Container
                const questionsContainer = document.getElementById('questionsList');
                console.log('- Fragen-Container existiert:', questionsContainer ? 'JA' : 'NEIN');
                console.log('- Fragen-Counter:', questionCounter);
                
                return {
                    modal: modal,
                    gdocsButton: gdocsButton,
                    gdocsContent: gdocsContent,
                    questionsContainer: questionsContainer,
                    user: currentSession.user
                };
            };
            
            window.testGDocsWorkflow = function() {
                console.log('üß™ Teste G-Docs Workflow...');
                
                // 1. √ñffne Modal
                openDocumentsModal();
                
                setTimeout(() => {
                    // 2. Wechsle zu G-Docs Tab
                    console.log('üìù Wechsle zu G-Docs Tab...');
                    switchDocumentsTab('gdocs');
                    
                    setTimeout(() => {
                        // 3. Pr√ºfe ob Tab sichtbar ist
                        const gdocsContent = document.getElementById('gdocsTabContent');
                        if (gdocsContent && gdocsContent.style.display !== 'none') {
                            console.log('‚úÖ G-Docs Tab ist sichtbar!');
                            
                            // 4. F√ºge Test-Frage hinzu
                            addQuestion();
                            console.log('‚úÖ Test-Frage hinzugef√ºgt!');
                        } else {
                            console.error('‚ùå G-Docs Tab ist nicht sichtbar!');
                        }
                    }, 500);
                }, 500);
            };
            
            window.createTestTemplate = function() {
                console.log('üß™ Erstelle Test-Template...');
                
                // Pr√ºfe ob G-Docs Tab sichtbar ist
                const gdocsContent = document.getElementById('gdocsTabContent');
                if (!gdocsContent || gdocsContent.style.display === 'none') {
                    console.error('‚ùå G-Docs Tab ist nicht sichtbar! √ñffne zuerst das Modal und wechsle zum G-Docs Tab.');
                    alert('‚ùå Bitte √∂ffnen Sie zuerst das Dokumente-Modal und wechseln Sie zum "üìù G-Docs Vorlagen" Tab!');
                    return;
                }
                
                // F√ºlle Test-Daten ein
                const nameField = document.getElementById('templateName');
                const urlField = document.getElementById('templateGdocsUrl');
                const descField = document.getElementById('templateDescription');
                
                if (!nameField || !urlField || !descField) {
                    console.error('‚ùå Template-Felder nicht gefunden!');
                    alert('‚ùå Template-Felder nicht gefunden! Stellen Sie sicher, dass der G-Docs Tab ge√∂ffnet ist.');
                    return;
                }
                
                nameField.value = 'Test Urlaubsantrag';
                urlField.value = 'https://docs.google.com/document/d/1234567890/edit';
                descField.value = 'Test-Vorlage f√ºr Urlaubsantr√§ge mit verschiedenen Fragetypen';
                console.log('‚úÖ Template-Grunddaten eingef√ºllt');
                
                // Entferne alle bestehenden Fragen
                const questionsList = document.getElementById('questionsList');
                if (questionsList) {
                    questionsList.innerHTML = '';
                    questionCounter = 0;
                    console.log('üßπ Bestehende Fragen entfernt');
                }
                
                // F√ºge Test-Fragen hinzu
                console.log('‚ûï F√ºge Test-Fragen hinzu...');
                
                // Frage 1
                addQuestion();
                if (document.getElementById('question-text-1')) {
                    document.getElementById('question-text-1').value = 'Vollst√§ndiger Name';
                    document.getElementById('question-type-1').value = 'text';
                    document.getElementById('question-placeholder-1').value = 'Vor- und Nachname';
                    console.log('‚úÖ Frage 1 hinzugef√ºgt');
                }
                
                // Frage 2
                addQuestion();
                if (document.getElementById('question-text-2')) {
                    document.getElementById('question-text-2').value = 'Zeitraum des Urlaubs';
                    document.getElementById('question-type-2').value = 'textarea';
                    document.getElementById('question-placeholder-2').value = 'Von - Bis, z.B. 01.01.2024 - 15.01.2024';
                    console.log('‚úÖ Frage 2 hinzugef√ºgt');
                }
                
                // Frage 3
                addQuestion();
                if (document.getElementById('question-text-3')) {
                    document.getElementById('question-text-3').value = 'Art des Urlaubs';
                    document.getElementById('question-type-3').value = 'select';
                    document.getElementById('question-type-3').dispatchEvent(new Event('change'));
                    setTimeout(() => {
                        const optionsField = document.getElementById('question-options-text-3');
                        if (optionsField) {
                            optionsField.value = 'Erholungsurlaub\nSonderurlaub\nKrankheit\nFortbildung';
                        }
                    }, 100);
                    console.log('‚úÖ Frage 3 hinzugef√ºgt');
                }
                
                // Frage 4
                addQuestion();
                if (document.getElementById('question-text-4')) {
                    document.getElementById('question-text-4').value = 'E-Mail-Adresse';
                    document.getElementById('question-type-4').value = 'email';
                    document.getElementById('question-placeholder-4').value = 'ihre.email@firma.de';
                    console.log('‚úÖ Frage 4 hinzugef√ºgt');
                }
                
                console.log(`‚úÖ Test-Template mit ${questionCounter} Fragen vorbereitet!`);
                console.log('üéØ Jetzt auf "üìù Vorlage hinzuf√ºgen" klicken!');
                
                // Scroll zum Submit-Button
                const submitButton = document.querySelector('#gdocsTabContent button[onclick="createGdocsTemplate()"]');
                if (submitButton) {
                    submitButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    submitButton.style.background = 'linear-gradient(135deg, #28a745 0%, #20a038 100%)';
                    submitButton.style.animation = 'pulse 1s infinite';
                }
            };
            
            window.debugDocuments = function() {
                console.log('üîç Dokumente Debug-Analyse:');
                
                // Pr√ºfe aktuellen Benutzer
                console.log('üë§ Aktueller Benutzer:', currentSession.user ? currentSession.user.username : 'KEIN BENUTZER');
                
                // Pr√ºfe Container
                const container = document.getElementById('documentsListContainer');
                console.log('üì¶ Dokumente-Container:', container ? 'GEFUNDEN' : 'NICHT GEFUNDEN');
                
                if (container) {
                    console.log('üìã Container-Inhalt:', container.innerHTML.substring(0, 200) + '...');
                }
                
                // Pr√ºfe welcher Tab aktiv ist
                const viewTab = document.getElementById('viewDocumentsTab');
                console.log('üëÅÔ∏è View-Tab sichtbar:', viewTab ? viewTab.style.display : 'TAB NICHT GEFUNDEN');
                
                // Teste API direkt
                if (currentSession.user) {
                    console.log('üîó Teste API direkt...');
                    testDocumentsAPI();
                }
                
                return {
                    user: currentSession.user,
                    container: container,
                    viewTab: viewTab
                };
            };
            
            window.testDocumentsAPI = async function() {
                console.log('üß™ Teste Dokumente-API direkt...');
                
                if (!currentSession.user) {
                    console.error('‚ùå Kein Benutzer angemeldet!');
                    return;
                }
                
                try {
                    const apiUrl = `/documents/${currentSession.user.username}`;
                    console.log('üîó API-URL:', API_BASE + apiUrl);
                    
                    const response = await fetch(API_BASE + apiUrl, {
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    console.log('üì° Response Status:', response.status);
                    console.log('üì° Response Headers:', [...response.headers.entries()]);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('üìä API-Daten erhalten:', data);
                    console.log('üìä Anzahl Dokumente:', data ? data.length : 'undefined');
                    
                    return data;
                    
                } catch (error) {
                    console.error('‚ùå API-Test fehlgeschlagen:', error);
                    return null;
                }
            };
            
            window.createTestDocument = async function() {
                console.log('üß™ Erstelle Test-Dokument...');
                
                if (!currentSession.user) {
                    console.error('‚ùå Kein Benutzer angemeldet!');
                    alert('‚ùå Bitte melden Sie sich zuerst an!');
                    return;
                }
                
                // √ñffne Modal und wechsle zu Create-Tab
                openDocumentsModal();
                
                setTimeout(() => {
                    switchDocumentsTab('create');
                    
                    setTimeout(() => {
                        // F√ºlle Test-Daten
                        const nameField = document.getElementById('docFullName');
                        const emailField = document.getElementById('docEmail');
                        const purposeField = document.getElementById('docPurpose');
                        const dateField = document.getElementById('docApplicationDate');
                        
                        if (nameField && emailField && purposeField) {
                            nameField.value = 'Max Mustermann';
                            emailField.value = 'max.mustermann@test.de';
                            purposeField.value = 'Test-Dokument f√ºr Debug-Zwecke';
                            if (dateField) dateField.value = new Date().toISOString().split('T')[0];
                            
                            console.log('‚úÖ Test-Daten eingef√ºllt');
                            console.log('üéØ Klicken Sie jetzt auf "Dokument erstellen"');
                            
                            // Highlight Submit-Button
                            const submitBtn = document.querySelector('#createDocumentTab button[onclick="createDocument()"]');
                            if (submitBtn) {
                                submitBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20a038 100%)';
                                submitBtn.style.animation = 'pulse 1s infinite';
                                submitBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        } else {
                            console.error('‚ùå Formular-Felder nicht gefunden!');
                            alert('‚ùå Formular-Felder nicht gefunden! Ist das Modal ge√∂ffnet?');
                        }
                    }, 500);
                }, 500);
            };
            
            window.testFullDocumentWorkflow = async function() {
                console.log('üß™ Teste vollst√§ndigen Dokument-Workflow...');
                
                // 1. Erstelle Test-Dokument direkt via API
                console.log('üìù 1. Erstelle Dokument via API...');
                
                const testDoc = {
                    fullName: 'Test User ' + Date.now(),
                    email: 'test@example.com',
                    purpose: 'Automatischer Test ' + new Date().toLocaleString(),
                    createdBy: currentSession.user.username,
                    applicationDate: new Date().toISOString().split('T')[0]
                };
                
                try {
                    const result = await apiCall('/create-document', {
                        method: 'POST',
                        body: JSON.stringify(testDoc)
                    });
                    
                    console.log('‚úÖ Dokument erstellt:', result);
                    
                    // 2. √ñffne Modal und teste Anzeige
                    console.log('üëÅÔ∏è 2. √ñffne Modal und teste Anzeige...');
                    openDocumentsModal();
                    
                    setTimeout(() => {
                        switchDocumentsTab('view');
                        
                        setTimeout(() => {
                            console.log('üîç 3. Pr√ºfe ob Dokument angezeigt wird...');
                            const container = document.getElementById('documentsListContainer');
                            
                            if (container) {
                                const hasTestDoc = container.innerHTML.includes(testDoc.fullName);
                                console.log('üìä Test-Dokument gefunden:', hasTestDoc);
                                
                                if (hasTestDoc) {
                                    console.log('‚úÖ WORKFLOW ERFOLGREICH!');
                                    alert('‚úÖ Workflow erfolgreich! Das Test-Dokument wurde erstellt und wird angezeigt.');
                                } else {
                                    console.log('‚ùå WORKFLOW FEHLGESCHLAGEN - Dokument nicht angezeigt');
                                    alert('‚ùå Workflow fehlgeschlagen! Dokument wurde erstellt, aber nicht angezeigt.');
                                }
                            }
                        }, 1000);
                    }, 500);
                    
                } catch (error) {
                    console.error('‚ùå Workflow-Test fehlgeschlagen:', error);
                    alert('‚ùå Workflow-Test fehlgeschlagen: ' + error.message);
                }
            };
            
            window.testDatabase = async function() {
                console.log('üß™ Teste Datenbank-Verbindung...');
                
                try {
                    const result = await apiCall('/test-db');
                    console.log('‚úÖ Datenbank-Test erfolgreich:', result);
                    
                    if (result.documents_table) {
                        console.log('‚úÖ Documents Tabelle ist verf√ºgbar');
                        console.log('üìä Anzahl Dokumente in DB:', result.documents_count);
                    } else {
                        console.error('‚ùå Documents Tabelle ist NICHT verf√ºgbar!');
                        console.error('‚ùå Fehler:', result.error);
                    }
                    
                    return result;
                    
                } catch (error) {
                    console.error('‚ùå Datenbank-Test fehlgeschlagen:', error);
                    return null;
                }
            };
            
            window.testTemplateWorkflow = async function() {
                console.log('üß™ Teste Template-Fragebogen-Workflow...');
                
                if (!currentSession.user) {
                    console.error('‚ùå Kein Benutzer angemeldet!');
                    return;
                }
                
                try {
                    // 1. Erstelle Test-Template
                    console.log('üìù 1. Erstelle Test-Template...');
                    const templateData = {
                        name: 'Test Fragebogen ' + Date.now(),
                        description: 'Automatischer Test-Fragebogen',
                        gdocsUrl: 'https://docs.google.com/document/d/test123/edit',
                        availableRanks: ['admin', 'user'],
                        questions: [
                            {
                                id: '1',
                                order: 1,
                                text: 'Vollst√§ndiger Name',
                                type: 'text',
                                placeholder: 'Vor- und Nachname',
                                required: true
                            },
                            {
                                id: '2',
                                order: 2,
                                text: 'E-Mail-Adresse',
                                type: 'email',
                                placeholder: 'ihre@email.de',
                                required: true
                            },
                            {
                                id: '3',
                                order: 3,
                                text: 'Grund der Anfrage',
                                type: 'textarea',
                                placeholder: 'Beschreiben Sie Ihr Anliegen',
                                required: false
                            }
                        ],
                        createdBy: currentSession.user.username
                    };
                    
                    const templateResult = await apiCall('/create-gdocs-template', {
                        method: 'POST',
                        body: JSON.stringify(templateData)
                    });
                    
                    console.log('‚úÖ Template erstellt:', templateResult);
                    const templateId = templateResult.templateId;
                    
                    // 2. F√ºlle Template aus
                    console.log('üìã 2. F√ºlle Template aus...');
                    const answers = {
                        'field-1': 'Max Mustermann Test',
                        'field-2': 'max.test@example.com',
                        'field-3': 'Dies ist ein automatischer Test des Fragebogen-Systems'
                    };
                    
                    const responseResult = await apiCall('/submit-template-response', {
                        method: 'POST',
                        body: JSON.stringify({
                            templateId: templateId,
                            answers: answers,
                            submittedBy: currentSession.user.username
                        })
                    });
                    
                    console.log('‚úÖ Fragebogen-Antwort gesendet:', responseResult);
                    
                    // 3. Pr√ºfe ob in "Meine Dokumente" angezeigt
                    console.log('üëÅÔ∏è 3. Pr√ºfe "Meine Dokumente"...');
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Kurz warten
                    
                    const documents = await apiCall(`/documents/${currentSession.user.username}`);
                    console.log('üìä Aktuelle Dokumente:', documents);
                    
                    const hasTestDoc = documents.some(doc => 
                        doc.full_name.includes('Max Mustermann Test') || 
                        doc.purpose.includes('Test Fragebogen')
                    );
                    
                    if (hasTestDoc) {
                        console.log('‚úÖ FRAGEBOGEN-WORKFLOW ERFOLGREICH!');
                        alert('‚úÖ Fragebogen-Workflow erfolgreich! Das ausgef√ºllte Formular erscheint in "Meine Dokumente".');
                    } else {
                        console.log('‚ùå FRAGEBOGEN-WORKFLOW FEHLGESCHLAGEN');
                        console.log('üìã Erwartetes Dokument nicht in Liste gefunden');
                        alert('‚ùå Fragebogen-Workflow fehlgeschlagen! Das Dokument wurde nicht erstellt.');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Template-Workflow-Test fehlgeschlagen:', error);
                    alert('‚ùå Template-Workflow-Test fehlgeschlagen: ' + error.message);
                }
            };
            
            window.debugServerLogs = function() {
                console.log('üìã Server-Log Hinweise:');
                console.log('1. √ñffnen Sie ein Terminal');
                console.log('2. Schauen Sie sich die server.js Konsolen-Ausgaben an');
                console.log('3. Suchen Sie nach ‚ùå Fehlern oder üìù Debug-Meldungen');
                console.log('4. Die Server-Logs zeigen genau, was schiefgeht');
                console.log('');
                console.log('üîç F√ºhren Sie auch testDatabase() aus, um die DB zu testen');
                console.log('üîç F√ºhren Sie testTemplateWorkflow() aus, um Frageb√∂gen zu testen');
            };
            
            console.log('üí° Debug-Befehle verf√ºgbar:');
            console.log('   - testDocumentsModal() -> √ñffnet das Modal direkt');
            console.log('   - checkDocumentsButton() -> Pr√ºft den Button-Status');
            console.log('   - checkModal() -> Pr√ºft den Modal-Status');
            console.log('   - forceShowModal() -> Zeigt das Modal mit Force-CSS an');
            console.log('   - debugGDocsTab() -> Vollst√§ndige G-Docs Tab Diagnose');
            console.log('   - testGDocsWorkflow() -> Automatischer Workflow-Test');
            console.log('   - createTestTemplate() -> Erstellt eine Test-Vorlage (nur wenn G-Docs Tab offen)');
            console.log('   - debugDocuments() -> Dokumente Debug-Analyse');
            console.log('   - testDocumentsAPI() -> Testet Dokumente-API direkt');
            console.log('   - createTestDocument() -> Erstellt Test-Dokument (mit UI)');
            console.log('   - testFullDocumentWorkflow() -> Vollst√§ndiger Dokument-Test');
            console.log('   - testDatabase() -> Testet Datenbank-Verbindung direkt');
            console.log('   - testTemplateWorkflow() -> Testet kompletten Fragebogen-Workflow');
            console.log('   - debugServerLogs() -> Zeigt Hinweise f√ºr Server-Log Debugging');
            // Funktionen global verf√ºgbar machen
    makeGlobal();
        });
    </script>
</body>
</html>












